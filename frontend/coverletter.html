<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>ASTRA ‚Ä¢ HIREX ‚Äî Cover Letter Generator v2.1.2</title>
  <meta name="description" content="Generate a JD-optimized, humanized cover letter using stored job description and LaTeX resume." />
  <meta name="author" content="Sri Akash Kadali" />
  <meta property="og:title" content="ASTRA ‚Ä¢ HIREX ‚Äî Cover Letter Generator v2.1.2" />
  <meta property="og:description" content="Draft and download a JD-specific, LaTeX cover letter with optional tone humanization." />
  <meta property="og:type" content="website" />

  <!-- CSP: allow blob/data for PDFs, workers, dev websockets, and same-origin HTTPS -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self' blob: data: https: http://127.0.0.1:8000 ws://127.0.0.1:8000 http://0.0.0.0:8000 ws://0.0.0.0:8000 https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root{
      --bg:#0a1020;--accent:#5bd0ff;--accent2:#a678ff;--muted:rgba(255,255,255,0.7);
      --card-bg:rgba(255,255,255,0.05);--card-border:rgba(255,255,255,0.08);
      --field-bg:#0f152b;
    }
    html, body { background:#0a1020; }
    body{
      background: radial-gradient(circle at 30% 20%, var(--bg) 0%, #03060f 80%) fixed;
      color:#e4ecff;font-family:"Inter","Segoe UI",Roboto,sans-serif;line-height:1.6;margin:0;overflow-x:hidden;
    }
    .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
    ::selection{ background:var(--accent); color:#000; }
    body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
      background:repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
                 repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);}
    body::after{content:"";position:fixed;width:420px;height:420px;top:20%;right:10%;pointer-events:none;z-index:0;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);filter: blur(60px);
      animation: floatGlow 10s ease-in-out infinite alternate;}
    @keyframes floatGlow{ from{transform:translateY(0) scale(1);opacity:.9;} to{transform:translateY(-30px) scale(1.05);opacity:.7;} }
    .menu-toggle,.theme-toggle{display:none!important;}

    /* Sidebar (fixed) */
    .sidebar{position:fixed;top:0;left:0;width:260px;height:100vh;z-index:5;
      display:flex;flex-direction:column;padding-top:.25rem;background:rgba(10,16,32,0.65);
      border-right:1px solid rgba(255,255,255,0.05);backdrop-filter: blur(18px);}
    .brand{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem .05rem;}
    .brand img{width:72px;height:auto;aspect-ratio:1/1;object-fit:contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));transition:transform .25s, filter .25s;}
    .brand img:hover{transform:scale(1.05);filter: drop-shadow(0 0 12px rgba(91,208,255,0.9));}
    .logo-text{font-weight:700;font-size:1.35rem;background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;color:transparent;}
    .vnav{list-style:none;padding:0;margin:.05rem 1rem 1rem;}
    .vnav li{margin-bottom:.42rem;}
    .vnav a{display:block;padding:.6rem 1rem;color:#cfd9ff;text-decoration:none;border-radius:10px;transition:background .2s,color .2s;}
    .vnav a:hover,.vnav a.active-link{background: rgba(91,208,255,0.15); color: var(--accent);}
    .sidebar .cta-primary{display:none;}

    /* Main */
    main.console{position:relative;z-index:2;padding:3rem 3rem 5rem;max-width:1600px;min-height:100vh;margin-left:260px;animation:fadeRise 1s;}
    footer{margin-left:260px;text-align:center;padding:2rem 1rem;color:#9aa7cc;border-top:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);}
    @media (max-width:880px){
      .sidebar{position:fixed;left:-100%;width:70%;transition:transform .3s ease;}
      body.nav-open .sidebar{transform:translateX(100%);}
      main.console,footer{margin-left:0;padding:1.25rem;}
      .brand{padding:.5rem 1rem .04rem}.brand img{width:60px}.logo-text{font-size:1.2rem}.vnav{margin:.02rem 1rem 1rem}
    }

    /* Content */
    .page-title{font-size:2.2rem;font-weight:700;margin-bottom:.6rem;text-align:center;
      background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:1px;}
    .muted{color:var(--muted);text-align:center;max-width:820px;margin:0 auto 2rem;}

    .form-section{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:1.75rem 2rem;margin-bottom:2rem;
      box-shadow:0 0 25px rgba(91,208,255,0.15);backdrop-filter:blur(14px);position:relative;overflow:hidden;transition:transform .4s, box-shadow .4s;}
    .form-section:hover{transform:translateY(-4px);box-shadow:0 0 35px rgba(91,208,255,0.25);}
    label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:.3px;}
    select{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:var(--field-bg);
      color:#fff;padding:10px 12px;font-size:14px;transition:border-color .25s, box-shadow .25s;appearance:none;}
    select:focus{border-color:var(--accent);box-shadow:0 0 12px rgba(91,208,255,0.35);outline:none;}
    option{background:var(--field-bg);color:#fff;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    @media (max-width:720px){.row{grid-template-columns:1fr;}}

    .btn{border:1px solid rgba(255,255,255,0.14);background:rgba(10,16,32,0.85);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;
      font-size:14px;letter-spacing:.3px;transition:background .2s, transform .15s;}
    .btn:hover{background:rgba(255,255,255,0.08);transform:translateY(-1px);}
    .btn.accent{border-color:var(--accent);color:var(--accent);box-shadow:0 0 15px rgba(91,208,255,0.15);}
    #meta_badge{margin-left:1rem;color:var(--muted);font-size:.9rem;}

    .preview-section{margin-top:1rem;}
    .tabs{display:flex;gap:.6rem;margin-bottom:.8rem;justify-content:center;flex-wrap:wrap;}
    .tab{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 12px;color:#c9d4ff;
      font-size:14px;cursor:pointer;transition:all .2s;}
    .tab:hover{border-color:var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(91,208,255,0.15);}
    .tab.active{background:var(--accent);color:#000;border:none;box-shadow:0 0 15px rgba(91,208,255,0.25);}
    .pane{height:70vh;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);
      overflow:hidden;backdrop-filter:blur(12px);box-shadow:0 0 18px rgba(91,208,255,0.08);transition:box-shadow .3s;}
    .pane.active{box-shadow:0 0 28px rgba(91,208,255,0.25);}
    .pane pre{margin:0;padding:14px;height:100%;overflow:auto;white-space:pre-wrap;word-break:break-word;
      font-family:"Fira Code",monospace;font-size:13px;color:#dfe7ff;}
    .pdf-frame{width:100%;height:100%;border:none;background:#0b0f1e;border-radius:12px;}

    #historyWrap{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
    @media (max-width:900px){#historyWrap{grid-template-columns:1fr}}

    #dl_btn{display:none;margin-left:.5rem}
    @keyframes fadeRise{ from{opacity:0; transform:translateY(25px);} to{opacity:1; transform:translateY(0);} }
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(15,21,43,.95);border:1px solid rgba(255,255,255,.1);
      color:#eaf2ff;padding:.6rem .9rem;border-radius:10px;display:none;z-index:9999}
  </style>
</head>

<body class="page-enter" data-app="hirex">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html" class="active-link" aria-current="page">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main id="content" class="console" role="main">
    <div class="main-inner">
      <h1 class="page-title anim rise">‚úâÔ∏è Cover Letter Generator</h1>
      <p class="muted">Select a stored <strong>Job Description + Resume</strong> pair, choose tone/length, and generate a tailored cover letter.</p>

      <section id="cl-form" class="form-section anim blur-rise" aria-labelledby="cl-form-title">
        <h2 id="cl-form-title" class="visually-hidden">Generate Cover Letter</h2>

        <div id="historyWrap">
          <div>
            <label for="historySelect">Select Previous JD + Resume</label>
            <select id="historySelect" aria-label="Previous JD and Resume pairs"></select>
          </div>
          <div>
            <label for="clHistorySelect">Cover Letter History</label>
            <select id="clHistorySelect" aria-label="Previously generated cover letters"></select>
          </div>
        </div>

        <div class="row" style="margin-top:1rem;">
          <div>
            <label for="toneSelect">Tone</label>
            <select id="toneSelect" aria-label="Cover letter tone">
              <option value="balanced" selected>Balanced (recommended)</option>
              <option value="warm">Warm</option>
              <option value="formal">Formal</option>
              <option value="confident">Confident</option>
              <option value="concise">Concise</option>
            </select>
          </div>
          <div>
            <label for="lengthSelect">Length</label>
            <select id="lengthSelect" aria-label="Cover letter length">
              <option value="short">Short (~120‚Äì180 words)</option>
              <option value="standard" selected>Standard (~180‚Äì280 words)</option>
              <option value="long">Long (~300‚Äì400 words)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:1.2rem;text-align:center;">
          <button class="btn accent" id="generate_btn" type="button">Generate Cover Letter</button>
          <button class="btn" id="dl_btn" type="button">Download PDF</button>
          <span id="meta_badge" aria-live="polite">Idle</span>
        </div>
      </section>

      <section class="preview-section anim fade" aria-label="Cover letter outputs">
        <div class="tabs" role="tablist" aria-label="Cover letter preview tabs">
          <button class="tab active" data-tab="pdf" role="tab" aria-selected="true" aria-controls="pane_pdf">üìÑ PDF</button>
          <button class="tab" data-tab="tex" role="tab" aria-selected="false" aria-controls="pane_tex">üßæ LaTeX</button>
          <button class="tab" data-tab="body" role="tab" aria-selected="false" aria-controls="pane_body">üß† Body</button>
        </div>

        <div id="pane_pdf" class="pane active" role="tabpanel">
          <div class="cl-toolbar" style="display:flex;gap:.5rem;justify-content:flex-end;margin:.5rem;">
            <button class="btn accent" id="cl_dl_pdf">‚¨áÔ∏è Download PDF</button>
            <button class="btn" id="cl_dl_tex">‚¨áÔ∏è Download .tex</button>
            <button class="btn" id="cl_copy_tex">üìã Copy LaTeX</button>
            <button class="btn" id="cl_cancel_btn" style="display:none;">‚ùå Cancel</button>
          </div>
          <iframe id="pdf_frame" class="pdf-frame" title="Cover Letter PDF" src="about:blank"></iframe>
        </div>
        <div id="pane_tex" class="pane" role="tabpanel" hidden>
          <pre id="cl-tex-output">(waiting‚Ä¶)</pre>
        </div>
        <div id="pane_body" class="pane" role="tabpanel" hidden>
          <pre id="body_output">(waiting‚Ä¶)</pre>
        </div>
      </section>
    </div>
  </main>

  <footer>
    &copy; 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>OpenAI</strong> + <strong>LaTeX</strong>
  </footer>

  <div id="toast" role="status" aria-live="polite"></div>
  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>

  <script>
    // ------- Mini utils -------
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const esc = (v) => String(v ?? "‚Äî").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = (msg, ms=2500) => { const t=$("#toast"); t.textContent=msg; t.style.display="block"; clearTimeout(window.__t0); window.__t0=setTimeout(()=>t.style.display="none", ms); };
    const setBadge = (s)=>{ const b=$("#meta_badge"); if(b) b.textContent=s; };
    const getTS = () => new Date().toISOString().replace(/[:.]/g,"-");
    const sanitize = s => String(s||"file").replace(/[\\/:*?"<>|]+/g,"_").trim() || "file";

    // Robust base64 handling (URL-safe + padding)
    const normalizeB64 = (b64="") => {
      let x = String(b64||"").trim();
      const i = x.indexOf("base64,"); if (i>=0) x = x.slice(i+7);
      x = x.replace(/[\r\n\s]/g,"").replace(/-/g,"+").replace(/_/g,"/");
      const pad = x.length % 4; return pad ? x + "=".repeat(4-pad) : x;
    };
    const safeAtob = (b64) => { try { return atob(normalizeB64(b64)); } catch { return ""; } };
    const b64toBlob = (b64, mime="application/pdf") => {
      const bytes = safeAtob(b64); if (!bytes) return null;
      const len = bytes.length; const arr = new Uint8Array(len);
      for (let i=0;i<len;i++) arr[i] = bytes.charCodeAt(i) & 0xff;
      return new Blob([arr], {type:mime});
    };

    const keyFrom = (obj) => {
      if (obj?.key) return String(obj.key).toLowerCase();
      const c = (obj?.company || "").toLowerCase().trim().replace(/\s+/g,"_");
      const r = (obj?.role || "").toLowerCase().trim().replace(/\s+/g,"_");
      return `${c}__${r}`;
    };

    // De-duplicate by company__role -> keep newest
    function dedupeByKey(items) {
      const seen = new Set();
      const out = [];
      for (const it of items) {
        const k = keyFrom(it);
        if (seen.has(k)) continue;
        seen.add(k);
        out.push({ ...it, __key: k });
      }
      return out;
    }

    // ------- Backend calls (aligned to /api/context v2.x) -------
    async function listContexts(limit=100) {
      const url = `/api/context/list?limit=${limit}`;
      const r = await fetch(url, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Failed to list contexts");
      const data = await r.json();
      return Array.isArray(data.items) ? data.items : [];
    }

    async function getContextByKey(key) {
      const r = await fetch(`/api/context/get?key=${encodeURIComponent(key)}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Context not found");
      return await r.json();
    }

    async function getLatestContext() {
      const r = await fetch(`/api/context/get?latest=1`, { credentials: "same-origin" });
      if (!r.ok) return null;
      try { return await r.json(); } catch { return null; }
    }

    async function saveCoverLetterToContext({ company, role, pdf_b64, tex_string, tone, length }) {
      const fd = new FormData();
      fd.append("company", company || "");
      fd.append("role", role || "");
      // Dual format for compatibility:
      fd.append("cover_letter_pdf_b64", pdf_b64 || "");
      fd.append("cover_letter_tex", tex_string || "");
      fd.append("cover_letter", JSON.stringify({
        tex: tex_string || "",
        pdf_b64: pdf_b64 || "",
        params: { tone, length }
      }));
      const res = await fetch("/api/context/save", { method: "POST", body: fd, credentials: "same-origin" });
      if (!res.ok) {
        let msg = "Failed to save cover letter";
        try { const j = await res.json(); msg = j.detail || msg; } catch {}
        throw new Error(msg);
      }
    }

    // ------- UI helpers -------
    function populatePairsSelect(select, pairs) {
      if (!pairs.length) {
        select.innerHTML = '<option disabled selected>No saved resumes</option>';
        return;
      }
      select.innerHTML = pairs.map(p =>
        `<option value="${esc(p.__key)}">${esc(p.company)} ‚Äî ${esc(p.role)}</option>`
      ).join("");
    }

    function populateCLHistorySelect(select, covers) {
      if (!covers.length) {
        select.innerHTML = '<option disabled selected>No cover letters yet</option>';
        return;
      }
      select.innerHTML = covers.map(p =>
        `<option value="${esc(p.__key)}">${esc(p.company)} ‚Äî ${esc(p.role)}</option>`
      ).join("");
    }

    let lastPdfUrl = "";
    function setPdfUrl(url) {
      const frame = $("#pdf_frame");
      if (!frame) return;
      if (lastPdfUrl) { try { URL.revokeObjectURL(lastPdfUrl); } catch{} }
      lastPdfUrl = url;
      frame.src = `${url}#view=FitH`;
    }

    function ensureToolbarHandlers({ url, tex, company, role }) {
      const btnPdf  = $("#cl_dl_pdf");
      const btnTex  = $("#cl_dl_tex");
      const btnCopy = $("#cl_copy_tex");

      const pdfName = sanitize(`HIREX_CoverLetter_${sanitize(company)}_${sanitize(role)}_${getTS()}.pdf`);
      const texName = sanitize(`HIREX_CoverLetter_${sanitize(company)}_${sanitize(role)}_${getTS()}.tex`);

      if (btnPdf) {
        btnPdf.onclick = async () => {
          try {
            const blob = await fetch(url).then(r=>r.blob());
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = pdfName;
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=>URL.revokeObjectURL(a.href), 600);
          } catch { toast("‚ùå Failed to download PDF."); }
        };
      }
      if (btnTex) {
        btnTex.onclick = () => {
          if (!(tex||"").trim()) return toast("‚ö†Ô∏è No LaTeX to download!");
          const blob = new Blob([tex], {type:"text/plain"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = texName;
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(()=>URL.revokeObjectURL(a.href), 600);
        };
      }
      if (btnCopy) {
        btnCopy.onclick = async () => {
          if (!(tex||"").trim()) return toast("‚ö†Ô∏è No LaTeX to copy!");
          try { await navigator.clipboard.writeText(tex); toast("‚úÖ LaTeX copied!"); }
          catch { toast("‚ö†Ô∏è Clipboard permission denied."); }
        };
      }

      // Legacy "Download PDF" button
      const dl = $("#dl_btn");
      if (dl) {
        dl.style.display = "inline-block";
        dl.onclick = async () => {
          try {
            const blob = await fetch(url).then(r=>r.blob());
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = pdfName;
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=>URL.revokeObjectURL(a.href), 600);
          } catch { toast("‚ùå Failed to download PDF."); }
        };
      }
    }

    // Robust BODY extraction (anchors or document env)
    function extractBodyFromTex(tex="") {
      if (!tex) return "";
      const m = tex.match(/^\s*%[-\s]*BODY-START[-\s]*\s*$([\s\S]*?)^\s*%[-\s]*BODY-END[-\s]*\s*$/im);
      if (m) return m[1].trim();
      const d = tex.match(/\\begin\{document\}([\s\S]*?)\\end\{document\}/i);
      if (d) return d[1].trim();
      // Fallback heuristic
      const m2 = tex.match(/Dear[^\n]*?,([\s\S]*?)Sincerely[, ]/i);
      return (m2 ? m2[1] : "").trim();
    }

    function renderOutputs(key, company, role, pdf_b64, tex_string) {
      // PDF
      const blob = b64toBlob(pdf_b64, "application/pdf");
      if (!blob) { toast("‚ö†Ô∏è Invalid PDF data"); return; }
      const url = URL.createObjectURL(blob);
      setPdfUrl(url);

      // TeX + Body
      $("#cl-tex-output").textContent = (tex_string || "").trim() || "(no tex returned)";
      $("#body_output").textContent = extractBodyFromTex(tex_string || "") || "(body not detected)";

      // Wire toolbar
      ensureToolbarHandlers({ url, tex: tex_string || "", company, role });

      // Persist lightweight client history (overwrite latest per key)
      const histKey = "hirex_coverletters";
      const ls = JSON.parse(localStorage.getItem(histKey) || "[]");
      const filtered = ls.filter(x => (x.__key || keyFrom(x)) !== key);
      filtered.unshift({
        __key: key, company, role,
        pdf_base64: pdf_b64, tex_string,
        saved_at: new Date().toISOString()
      });
      localStorage.setItem(histKey, JSON.stringify(filtered.slice(0, 20)));
    }

    // Cancel/timeout plumbing
    let inflightCtrl = null;
    let inflightTimer = null;
    function attachCancel(enable) {
      const btn = $("#cl_cancel_btn");
      if (!btn) return;
      btn.style.display = enable ? "inline-block" : "none";
      btn.onclick = () => {
        if (inflightCtrl) {
          inflightCtrl.abort();
          toast("üõë Generation canceled.");
          setBadge("Canceled");
          attachCancel(false);
          if (inflightTimer) { clearTimeout(inflightTimer); inflightTimer = null; }
        }
      };
    }

    async function generateCoverLetterFromKey(key, tone, length) {
      setBadge("Preparing‚Ä¶");
      const ctx = await getContextByKey(key);

      const company = ctx.company || ctx.company_name || "";
      const role = ctx.role || "";
      const jd = (ctx.jd_text || "").trim();
      const resume = (ctx.humanized?.tex || ctx.humanized_tex || ctx.resume_tex || "").trim();

      if (!jd || !resume) throw new Error("Selected context is missing JD or Resume text.");

      const useHumanize =
        (window.HIREX?.getHumanizeState && window.HIREX.getHumanizeState()) ||
        (localStorage.getItem("hirex_use_humanize") === "true") ||
        (localStorage.getItem("hirex-use-humanize") !== "off"); // default ON

      const fd = new FormData();
      fd.append("jd_text", jd);
      fd.append("resume_tex", resume);
      fd.append("use_humanize", useHumanize ? "true" : "false");
      fd.append("tone", tone);
      fd.append("length", length);

      setBadge("Generating‚Ä¶");
      inflightCtrl = new AbortController();
      inflightTimer = setTimeout(() => inflightCtrl.abort(), 180000); // 3m
      attachCancel(true);

      try {
        const r = await fetch("/api/coverletter", { method:"POST", body: fd, credentials: "same-origin", signal: inflightCtrl.signal });
        if (!r.ok) {
          const err = await r.text().catch(()=>r.statusText);
          throw new Error(err || "Cover letter generation failed.");
        }
        const data = await r.json().catch(()=> ({}));

        const pdf_b64 = data.pdf_base64 || data.cover_letter_pdf_b64 || "";
        const tex_str = data.tex_string || data.cover_letter_tex || "";

        if (!pdf_b64 && !tex_str) throw new Error("Empty cover letter response from backend.");

        // Render immediately
        setBadge("Rendering‚Ä¶");
        renderOutputs(key, company, role, pdf_b64, tex_str);

        // Persist to backend memory
        try {
          await saveCoverLetterToContext({
            company, role, pdf_b64, tex_string: tex_str, tone, length
          });
        } catch (e) {
          console.warn("[HIREX] saveCoverLetterToContext:", e);
        }

        toast(`‚úÖ Cover letter ready for ${company || "Company"}`);
        setBadge("Done");
      } catch (e) {
        if (e.name === "AbortError") {
          toast("‚ö†Ô∏è Generation canceled or timed out (3 min).");
          setBadge("Canceled / Timed out");
        } else {
          toast("‚ùå " + (e.message || "Unexpected error"));
          setBadge("Error");
        }
      } finally {
        if (inflightTimer) { clearTimeout(inflightTimer); inflightTimer = null; }
        inflightCtrl = null;
        attachCancel(false);
      }
    }

    // Tabs wiring (ARIA)
    document.addEventListener("click",(e)=>{
      const tab = e.target.closest(".tab"); if(!tab) return;
      $$(".tab").forEach(t=>{t.classList.remove("active");t.setAttribute("aria-selected","false");});
      tab.classList.add("active"); tab.setAttribute("aria-selected","true");
      ["pdf","tex","body"].forEach(x=>{
        const p=$("#pane_"+x); const on=(x===tab.dataset.tab);
        p.hidden=!on; p.classList.toggle("active", on);
      });
    });

    // ------- Bootstrap -------
    document.addEventListener("DOMContentLoaded", async () => {
      const selectPairs = $("#historySelect");
      const selectCL = $("#clHistorySelect");
      const genBtn = $("#generate_btn");

      try {
        setBadge("Loading history‚Ä¶");
        // 1) List contexts (newest-first)
        const items = await listContexts(200);

        // 2) Dedupe by key (company__role)
        const uniq = dedupeByKey(items);

        // 3) Split: contexts with resumes vs contexts with saved cover letters
        const withCover = uniq.filter(c =>
          !!(c.cover_letter_pdf_b64 || c.cover_letter_tex || c.cover_letter || c.tex_string && c.pdf_base64)
        );

        populatePairsSelect(selectPairs, uniq);
        populateCLHistorySelect(selectCL, withCover);

        // Load a saved CL instantly when chosen
        selectCL.addEventListener("change", async () => {
          const key = selectCL.value;
          if (!key) return;
          setBadge("Loading cover letter‚Ä¶");
          try {
            const c = await getContextByKey(key);
            const pdf = c.cover_letter_pdf_b64 || c.pdf_base64 || "";
            const tex = c.cover_letter_tex || c.tex_string || "";
            if (pdf || tex) {
              const company = c.company || c.company_name || "";
              const role = c.role || "";
              renderOutputs(key, company, role, pdf, tex);
              setBadge("Loaded");
              toast("Loaded saved cover letter.");
              document.querySelector('.tab[data-tab="pdf"]')?.click();
            } else {
              toast("Selected entry has no saved cover letter.");
              setBadge("Idle");
            }
          } catch (e) {
            toast(String(e));
            setBadge("Idle");
          }
        });

        // Generate from selected JD+Resume pair
        genBtn.addEventListener("click", async () => {
          const key = selectPairs.value;
          if (!key) { toast("Please select a JD + Resume pair."); return; }
          genBtn.disabled = true;
          try {
            const tone = $("#toneSelect").value;
            const length = $("#lengthSelect").value;
            await generateCoverLetterFromKey(key, tone, length);
            document.querySelector('.tab[data-tab="pdf"]')?.click();
          } finally {
            genBtn.disabled = false;
          }
        });

        // Auto-load most recent server memory if nothing rendered yet
        try {
          const latest = await getLatestContext();
          if (latest) {
            const pdf = latest.cover_letter_pdf_b64 || latest.cover_letter?.pdf_b64 || latest.pdf_base64 || "";
            const tex = latest.cover_letter_tex || latest.cover_letter?.tex || latest.tex_string || "";
            if (pdf || tex) {
              const key = keyFrom(latest);
              const company = latest.company || latest.company_name || "Company";
              const role = latest.role || "Role";
              renderOutputs(key, company, role, pdf, tex);
              document.querySelector('.tab[data-tab="pdf"]')?.click();
              setBadge("Loaded latest");
              toast("‚òÅÔ∏è Loaded latest cover letter from server memory.");
            }
          }
        } catch (e) {
          console.warn("[HIREX] latest fetch failed:", e);
        }

        setBadge("Idle");
      } catch (e) {
        toast("History load failed ‚Äî check backend.");
        setBadge("Idle");
        // Fallback to local-only cover letters (if any)
        const ls = JSON.parse(localStorage.getItem("hirex_coverletters") || "[]");
        if (ls.length) {
          selectCL.innerHTML = ls.map(x => `<option value="${esc(x.__key)}">${esc(x.company)} ‚Äî ${esc(x.role)}</option>`).join("");
          selectCL.addEventListener("change", () => {
            const it = ls.find(a => a.__key===selectCL.value);
            if (it) renderOutputs(it.__key, it.company, it.role, it.pdf_base64, it.tex_string);
          });
        } else {
          selectCL.innerHTML = '<option disabled selected>No cover letters yet</option>';
        }
        selectPairs.innerHTML = '<option disabled selected>History unavailable</option>';
      }

      window.HIREX?.debugLog?.("COVER LETTER PAGE LOADED",{version:"v2.1.2"});
    });

    // Revoke last PDF URL on unload
    window.addEventListener("beforeunload", () => {
      if (lastPdfUrl) { try { URL.revokeObjectURL(lastPdfUrl); } catch{} }
    });
  </script>
</body>
</html>

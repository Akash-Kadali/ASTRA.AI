
/* FILE: ./preview.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>ASTRA ‚Ä¢ HIREX ‚Äî Optimized Resume Viewer v2.1.2</title>
  <meta name="description" content="Compare AI-optimized and humanized LaTeX resumes with JD-fit analysis, PDF preview, and download options in HIREX v2.1.2." />
  <meta name="author" content="Sri Akash Kadali" />
  <meta property="og:title" content="ASTRA ‚Ä¢ HIREX Preview v2.1.2 ‚Äî Optimized Resume Viewer" />
  <meta property="og:description" content="Interactive viewer for your AI-optimized & humanized resumes with JD fit score analytics and memory." />
  <meta property="og:image" content="/static/assets/og-preview.png" />
  <meta property="og:type" content="website" />

  <!-- CSP tuned for local dev + blob iframe PDFs + dev websockets -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self'
                       blob:
                       http://127.0.0.1:8000 ws://127.0.0.1:8000
                       http://0.0.0.0:8000 ws://0.0.0.0:8000
                       http://localhost:8000 ws://localhost:8000
                       https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="manifest" href="/static/manifest.json" />
  <link rel="preload" href="/static/assets/logo.png" as="image" />
  <link rel="preconnect" href="https://api.openai.com" crossorigin />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root{
      --accent:#5bd0ff; --accent2:#9f78ff; --bg:#0a1020;
      --muted:rgba(255,255,255,0.7); --panel:rgba(255,255,255,0.05);
      --stroke:rgba(255,255,255,0.08); --glow:0 0 25px rgba(91,208,255,0.25);
    }

    body{
      background: radial-gradient(circle at 25% 20%, #0a1020 0%, #03060f 80%) fixed;
      color:#e4ecff; font-family:"Inter","Segoe UI",Roboto,sans-serif;
      line-height:1.6; overflow-x:hidden; margin:0; position:relative; min-height:100vh;
    }
    ::selection{ background:var(--accent); color:#000; }

    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);
    }
    body::after{
      content:""; position:fixed; width:450px; height:450px; top:25%; right:10%;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);
      filter: blur(70px); animation: floatGlow 12s ease-in-out infinite alternate;
      z-index:0; pointer-events:none;
    }
    @keyframes floatGlow{ from{transform:translateY(0) scale(1);opacity:.9;} to{transform:translateY(-30px) scale(1.05);opacity:.7;} }

    .menu-toggle,.theme-toggle{ display:none !important; }

    /* Sidebar */
    .sidebar{ display:flex; flex-direction:column; padding-top:.25rem; }
    @media (min-width:880px){
      .sidebar{
        position:fixed; top:0; left:0; width:260px; height:100vh;
        background:rgba(10,16,32,0.65); border-right:1px solid rgba(255,255,255,0.05);
        backdrop-filter: blur(18px); z-index:5;
      }
      main.console, footer{ margin-left:260px; }
    }
    @media (max-width:879px){
      .sidebar{
        position:fixed; left:-100%; top:0; width:75%; height:100vh;
        background:rgba(10,16,32,0.95); transition:transform .3s ease; z-index:20;
      }
      body.nav-open .sidebar{ transform:translateX(100%); }
    }

    .brand{ display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem .05rem; }
    .brand img{
      width:72px; height:auto; aspect-ratio:1/1; object-fit:contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));
      transition: transform .25s, filter .25s;
    }
    .brand img:hover{ transform:scale(1.05); filter: drop-shadow(0 0 12px rgba(91,208,255,0.9)); }
    .logo-text{
      background: linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      font-weight:700; font-size:1.35rem;
    }

    .vnav{ list-style:none; padding:0; margin:.05rem 1rem .75rem; }
    .vnav li{ margin-bottom:.42rem; }
    .vnav a{
      color:#cfd9ff; text-decoration:none; display:block; padding:.6rem 1rem; border-radius:10px;
      transition: background .2s, color .2s;
    }
    .vnav a:hover,.vnav a.active-link{ background: rgba(91,208,255,0.15); color: var(--accent); }

    .sidebar .cta-primary{
      display:block; margin:1rem; margin-top:auto; width:calc(100% - 2rem);
      background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff;
      border:none; border-radius:10px; padding:.6rem; font-weight:600; cursor:pointer;
      transition: transform .25s;
    }
    .sidebar .cta-primary:hover{ transform: translateY(-2px); }

    /* Main */
    main.console{ position:relative; z-index:2; padding:3rem 3rem 5rem; animation: fadeRise 1s ease; }
    @keyframes fadeRise{ from{opacity:0; transform:translateY(25px);} to{opacity:1; transform:translateY(0);} }

    h1{
      font-size:2.2rem; font-weight:700;
      background: linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      margin:0 0 1rem 0;
    }

    .btn{
      border:1px solid rgba(255,255,255,0.14); background:rgba(10,16,32,0.85);
      color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px;
      transition:background .2s, transform .15s;
    }
    .btn:hover{ background:rgba(255,255,255,0.08); transform:translateY(-1px); }
    .btn.accent{ border-color:var(--accent); color:var(--accent); box-shadow:0 0 15px rgba(91,208,255,0.15); }

    /* Fit Score */
    #fit-score-card{
      background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1);
      border-radius:14px; padding:1rem 1.25rem; min-width:220px; text-align:center; box-shadow:var(--glow);
      transition: transform .25s ease;
    }
    #fit-score-card:hover{ transform: translateY(-3px); }
    .fit-circle{
      width:100px; height:100px; border-radius:50%; border:4px solid var(--accent);
      margin:0 auto .75rem; position:relative; transition:border-color .25s ease;
    }
    .fit-circle::after{
      content: attr(data-score) "%"; position:absolute; top:50%; left:50%;
      transform: translate(-50%,-50%); font-size:1.3rem; font-weight:700;
    }

    /* PDF Cards */
    #pdf-container{ display:flex; flex-direction:column; align-items:center; gap:3rem; width:100%; }
    .pdf-card{
      width:100%; max-width:1200px; background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:1.25rem; box-shadow: var(--glow);
      transition: transform .25s, box-shadow .25s, border-color .25s;
    }
    .pdf-card:hover{ transform: translateY(-4px); box-shadow: 0 0 40px rgba(91,208,255,0.25); }
    .pdf-card.preferred{ border-color: var(--accent); box-shadow: 0 0 40px rgba(91,208,255,0.35); }
    .pdf-frame iframe{ width:100%; height:88vh; border:none; border-radius:12px; background:#0e1428; }

    /* LaTeX Output */
    #tex-output{
      white-space: pre-wrap; color:#dfe7ff; font-family:"Fira Code",monospace; font-size:.9rem; line-height:1.6;
      background:rgba(10,16,32,0.85); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:1rem;
      box-shadow: 0 0 20px rgba(91,208,255,0.1); overflow-x:auto; max-height:80vh;
    }

    footer{
      text-align:center; padding:2rem 1rem; font-size:.9rem; color:#9aa7cc;
      border-top:1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px);
    }

    @media (max-width:880px){
      .brand{ padding:.5rem 1rem .04rem; }
      .brand img{ width:60px; }
      .logo-text{ font-size:1.2rem; }
      .vnav{ margin:.02rem 1rem .75rem; }
    }

    /* Mobile hamburger */
    .hamburger{
      position:fixed; top:12px; left:16px; z-index:30;
      background:rgba(255,255,255,0.08); color:#eaf0ff;
      border:1px solid rgba(255,255,255,0.12); border-radius:10px;
      padding:.45rem .65rem; cursor:pointer; display:none;
      backdrop-filter: blur(8px);
    }
    @media(max-width:879px){ .hamburger{ display:block; } }
  </style>
</head>

<body class="page-enter" data-app="hirex">
  <!-- Mobile hamburger -->
  <button id="nav-toggle" class="hamburger" aria-label="Toggle navigation" aria-controls="sidebar" aria-expanded="false">‚ò∞</button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>

    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html" class="active-link" aria-current="page">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>

    <button class="cta-primary" onclick="window.location.href='/index.html'">üöÄ Optimize Again</button>
  </aside>

  <!-- Main -->
  <main class="console" id="content" role="main">
    <div class="main-inner">
      <div class="header-row anim rise" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:2rem;">
        <h1>Optimized Resume Preview</h1>
        <div id="fit-score-card" class="anim fade" aria-live="polite">
          <div class="fit-circle" id="fitCircle" data-score="--"></div>
          <h2>üéØ JD Fit Score</h2>
          <p>Rounds: <span id="fit-rounds">--</span></p>
          <p id="fit-tier">Awaiting Analysis‚Ä¶</p>
        </div>
      </div>

      <p class="muted">
        Review your <strong>AI-optimized</strong> and <strong>humanized</strong> resumes side by side.
        Compare outputs, verify JD-fit metrics, and download or copy your LaTeX source.
      </p>

      <section id="pdf-section" class="anim fade" aria-labelledby="pdf-viewer-title">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h2 id="pdf-viewer-title">üìÑ Resume PDF Viewer</h2>
          <button id="refresh-pdfs" class="btn accent" type="button" aria-controls="pdf-container" onclick="location.reload()">‚Üª Refresh PDFs</button>
        </div>
        <div id="pdf-container" aria-live="polite">
          <p style="color:#bbb;text-align:center;">Loading your latest optimized resumes‚Ä¶</p>
        </div>
      </section>

      <section id="latex-section" class="anim rise" aria-labelledby="latex-output-title">
        <h2 id="latex-output-title">üß† Optimized LaTeX Output</h2>
        <pre id="tex-output" role="region" aria-live="polite">% Your optimized LaTeX will appear here...</pre>
        <div style="margin-top:1rem;display:flex;gap:.75rem;flex-wrap:wrap;">
          <button id="download-tex" class="btn accent" type="button">‚¨áÔ∏è Download .tex</button>
          <button id="copy-tex" class="btn" type="button">üìã Copy Code</button>
        </div>
      </section>
    </div>
  </main>

  <footer>
    &copy; 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>OpenAI</strong> + <strong>LaTeX</strong> |
    <a href="https://github.com/Akash-Kadali" target="_blank" rel="noopener noreferrer">GitHub</a>
  </footer>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Scripts -->
  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>
  <!-- preview.js safely no-ops if #history-list is absent -->
  <script src="/static/js/preview.js?v=2.1.2" defer></script>

  <!-- Minimal boot/wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Mobile nav toggle
      const navToggle = document.getElementById('nav-toggle');
      navToggle?.addEventListener('click', () => {
        const on = !document.body.classList.contains('nav-open');
        document.body.classList.toggle('nav-open', on);
        navToggle.setAttribute('aria-expanded', String(on));
      });

      (window.ASTRA ?? window.HIREX)?.debugLog?.('PREVIEW PAGE LOADED', { version: 'v2.1.2' });
    });
  </script>
</body>
</html>

/* FILE: ./mastermind.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>MasterMind | ASTRA ‚Äî Standalone Assistant v2.1.2</title>
  <meta name="description" content="MasterMind ‚Äî a standalone ChatGPT-class assistant for research, coding, writing, and brainstorming." />
  <meta name="author" content="Sri Akash Kadali" />
  <meta property="og:title" content="MasterMind | ASTRA ‚Äî Standalone Assistant" />
  <meta property="og:description" content="A fast, versatile assistant for research, code, writing, and strategy." />
  <meta property="og:image" content="/static/assets/og-preview.png" />
  <meta property="og:type" content="website" />

  <!-- CSP aligned with app (local API, dev websockets, blob/data, OpenAI) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self'
                       blob:
                       http://127.0.0.1:8000 ws://127.0.0.1:8000
                       http://0.0.0.0:8000 ws://0.0.0.0:8000
                       http://localhost:8000 ws://localhost:8000
                       https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="preload" href="/static/assets/logo.png" as="image" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root{
      --bg:#0a1020;
      --panel:#101622;
      --muted:rgba(255,255,255,0.70);
      --accent:#5bd0ff;
      --accent2:#a678ff;
      --radius:12px;
      --maxw:780px;
      --sidebar-w:260px;
    }

    body{
      margin:0; background:var(--bg); color:#e6ecff;
      font-family:"Inter","Segoe UI",system-ui,Roboto,sans-serif;
      -webkit-font-smoothing:antialiased; overflow-x:hidden; line-height:1.6;
      isolation:isolate; min-height:100vh; position:relative;
    }
    ::selection{ background:var(--accent); color:#000; }
    .menu-toggle,.theme-toggle,.bg-boxes{ display:none !important; }

    .gpt-bg{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 600px at 50% 0%, rgba(255,255,255,0.06), transparent 70%),
        radial-gradient(900px 500px at 50% 100%, rgba(255,255,255,0.04), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0) 35%, rgba(255,255,255,0.02));
    }
    @media (max-width: 900px){
      .gpt-bg{
        background:
          radial-gradient(900px 450px at 50% 0%, rgba(255,255,255,0.06), transparent 70%),
          radial-gradient(680px 380px at 50% 100%, rgba(255,255,255,0.04), transparent 70%),
          linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0) 35%, rgba(255,255,255,0.02));
      }
    }

    /* Sidebar */
    .sidebar{
      display:flex; flex-direction:column; padding-top:.25rem;
      position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh;
      background:#0d1320cc; backdrop-filter:blur(16px);
      border-right:1px solid rgba(255,255,255,0.06); z-index:2;
    }
    @media(max-width:879px){
      .sidebar{left:-100%; width:70%; transition:transform .3s ease}
      body.nav-open .sidebar{transform:translateX(100%)}
    }
    .brand{display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem .05rem}
    .brand img{width:72px; height:auto; aspect-ratio:1/1; object-fit:contain; filter:drop-shadow(0 0 6px rgba(91,208,255,.6)); transition:transform .25s, filter .25s}
    .brand img:hover{transform:scale(1.05); filter:drop-shadow(0 0 12px rgba(91,208,255,.9))}
    .logo-text{background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:700; font-size:1.35rem; letter-spacing:.3px}
    .vnav{list-style:none; padding:0; margin:.05rem 1rem 1rem}
    .vnav li{margin-bottom:.42rem}
    .vnav a{display:block; padding:.6rem 1rem; color:#cfd9ff; text-decoration:none; border-radius:10px; transition:background .2s,color .2s}
    .vnav a:hover,.vnav a.active-link{background:rgba(91,208,255,.15); color:var(--accent)}

    /* Mobile hamburger */
    .hamburger{
      position:fixed; top:12px; left:16px; z-index:3;
      background:rgba(255,255,255,0.08); color:#eaf0ff;
      border:1px solid rgba(255,255,255,0.12); border-radius:10px;
      padding:.45rem .65rem; cursor:pointer; display:none;
      backdrop-filter: blur(8px);
    }
    @media(max-width:879px){ .hamburger{ display:block; } }

    /* Main */
    main.console{
      display:block !important; position:relative; z-index:1;
      margin-left:var(--sidebar-w); min-height:100vh;
      padding:24px 24px 140px;
      animation:fadeRise .6s ease;
    }
    @keyframes fadeRise{from{opacity:0; transform:translateY(25px)} to{opacity:1; transform:none}}
    @media(max-width:879px){ main.console{margin-left:0; padding:20px 16px 140px} }

    .topbar{
      width:100%; max-width:var(--maxw); margin-inline:auto;
      display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
      position:sticky; top:0; z-index:1; backdrop-filter: blur(8px);
    }
    .topbar select, .topbar button, .topbar input[type="checkbox"]{
      height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:#0f1628; color:#eaf0ff; padding:0 10px; font-size:13px;
    }
    .topbar label{ color:var(--muted); font-size:12px; display:flex; align-items:center; gap:6px; }
    .topbar .btn{background:var(--accent); color:#0a1020; border:none; font-weight:600; cursor:pointer}
    .topbar .btn:hover{background:#72d7ff}

    .header-note{
      width:100%; max-width:var(--maxw); margin:0 auto 8px; color:var(--muted); font-size:.95rem; text-align:center;
    }

    #session_list{
      width:100%; max-width:var(--maxw); margin:6px auto 10px; display:flex; gap:8px; flex-wrap:wrap;
    }
    .session-item{
      padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:#0f1628; cursor:pointer; font-size:12px; color:#cfe2ff;
    }
    .session-item.active{ border-color:var(--accent); color:#000; background:var(--accent); }

    .chat-stream{ width:100%; max-width:var(--maxw); margin-inline:auto; }
    .msg-row{ display:flex; gap:10px; margin:10px 0; align-items:flex-start; }
    .msg-row.user{ flex-direction:row-reverse; }
    .msg-row .avatar{
      width:32px; height:32px; display:grid; place-items:center;
      border-radius:50%; background:#182135; border:1px solid rgba(255,255,255,.08);
      font-size:16px;
    }
    .msg-row .bubble{
      background:#0f1524; border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px 14px; color:#e8eeff; font-size:14px; line-height:1.55;
      max-width:calc(var(--maxw) - 60px);
      word-wrap:break-word; overflow-wrap:anywhere;
    }
    .msg-row.user .bubble{ background:#0e1a2e; }
    .bubble.typing{ opacity:.85; font-style:italic; }

    .composer{
      position:sticky; bottom:0; left:0; right:0;
      margin-top:24px; padding:12px 0 20px; backdrop-filter: blur(8px);
    }
    .composer .bar{
      width:100%; max-width:var(--maxw); margin-inline:auto;
      background:#0f1628; border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:10px; display:flex; gap:10px;
      box-shadow: 0 6px 28px rgba(0,0,0,0.25);
    }
    .composer textarea{
      flex:1; min-height:52px; max-height:240px; resize:vertical;
      background:transparent; border:none; outline:none;
      color:#eaf0ff; font-size:14px; line-height:1.45;
    }
    .composer .send{
      border:none; border-radius:12px; padding:0 14px;
      background:var(--accent); color:#0a1020; font-weight:700; cursor:pointer;
      height:40px; align-self:flex-end;
    }
    .composer .send:hover{ background:#72d7ff; }
    .composer .hint{ width:100%; max-width:var(--maxw); margin:6px auto 0; color:var(--muted); font-size:12px; text-align:center; }

    .vnav a:focus, .send:focus, select:focus, textarea:focus { outline:2px solid var(--accent); outline-offset:2px; }
    .page-enter{opacity:0; animation:fadeIn .45s ease .05s forwards}
    @keyframes fadeIn{to{opacity:1}}
  </style>
</head>

<body class="page-enter" data-app="astra">
  <div class="gpt-bg" aria-hidden="true"></div>

  <!-- Mobile hamburger -->
  <button id="nav-toggle" class="hamburger" aria-label="Toggle navigation" aria-controls="sidebar" aria-expanded="false">‚ò∞</button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html" class="active-link" aria-current="page">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main id="content" class="console" role="main">
    <div class="topbar" role="toolbar" aria-label="Chat settings">
      <select id="persona" aria-label="Assistant persona">
        <option value="General" selected>General</option>
        <option value="Researcher">Researcher</option>
        <option value="CodeHelper">Code Helper</option>
        <option value="DataAnalyst">Data Analyst</option>
        <option value="Writer">Writer</option>
      </select>
      <select id="model" aria-label="Model selection">
        <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
        <option value="gpt-4o">gpt-4o</option>
      </select>
      <select id="tone" aria-label="Tone (optional)">
        <option value="balanced" selected>Balanced</option>
        <option value="friendly">Friendly</option>
        <option value="formal">Formal</option>
        <option value="concise">Concise</option>
        <option value="creative">Creative</option>
      </select>
      <label for="use_context">
        <input type="checkbox" id="use_context" checked />
        Use context
      </label>
      <button id="refresh_sessions" class="btn" type="button">‚Üª Refresh</button>
      <button id="new_session" class="btn" type="button">+ New chat</button>
    </div>

    <p class="header-note">MasterMind ‚Ä¢ Ask anything ‚Äî research, code, writing, strategy.</p>

    <!-- Optional sessions tray -->
    <div id="session_list" aria-label="Sessions"></div>

    <!-- Chat stream -->
    <div id="chat_stream" class="chat-stream" aria-live="polite">
      <div class="msg-row bot">
        <div class="avatar" aria-hidden="true">ü§ñ</div>
        <div class="bubble">Hi, I‚Äôm MasterMind! Pick a persona above or just start chatting.</div>
      </div>
    </div>

    <div class="composer" role="region" aria-label="Message composer">
      <div class="bar">
        <textarea id="chat_input" placeholder="Message MasterMind‚Ä¶" aria-label="Message input"></textarea>
        <button id="send_btn" class="send" type="button">Send</button>
      </div>
      <div class="hint">Tip: Press Ctrl/Cmd + Enter to send, or click Send.</div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Load order: util -> ui -> mastermind -->
  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>
  <script src="/static/js/mastermind.js?v=2.1.2" defer></script>

  <!-- Minimal boot/wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Mobile nav toggle
      const navToggle = document.getElementById('nav-toggle');
      navToggle?.addEventListener('click', () => {
        const on = !document.body.classList.contains('nav-open');
        document.body.classList.toggle('nav-open', on);
        navToggle.setAttribute('aria-expanded', String(on));
      });

      // Ctrl/Cmd + Enter to send
      const input = document.getElementById('chat_input');
      const send  = document.getElementById('send_btn');
      input?.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          send?.click();
        }
      });

      (window.ASTRA ?? window.HIREX)?.debugLog?.('MASTERMIND PAGE LOADED', { version: 'v2.1.2' });
    });
  </script>
</body>
</html>

/* FILE: ./index.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />
  <title>ASTRA ‚Ä¢ HIREX ‚Äî High Resume eXpert v2.1.2</title>
  <meta name="description" content="HIREX generates ATS-safe, JD-aligned LaTeX resumes from your base_resume.tex using AI." />
  <meta name="author" content="Sri Akash Kadali" />

  <!-- CSP for local dev + API calls + blobs -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self'
                       blob:
                       http://127.0.0.1:8000 ws://127.0.0.1:8000
                       http://0.0.0.0:8000 ws://0.0.0.0:8000
                       http://localhost:8000 ws://localhost:8000;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root {
      --accent:#5bd0ff; --accent2:#9f78ff;
      --bg:#0a1020; --muted:rgba(255,255,255,0.7);
      --panel:rgba(255,255,255,0.05);
      --stroke:rgba(255,255,255,0.08);
      --glow:0 0 25px rgba(91,208,255,0.25);
    }

    body {
      background: radial-gradient(circle at 25% 20%, #0a1020 0%, #03060f 80%) fixed;
      color:#e4ecff; font-family:"Inter","Segoe UI",Roboto,sans-serif;
      line-height:1.6; overflow-x:hidden; margin:0; position:relative; min-height:100vh;
    }
    ::selection{ background:var(--accent); color:#000; }

    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);
    }
    body::after{
      content:""; position:fixed; width:450px; height:450px; top:25%; right:10%;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);
      filter: blur(70px); animation: floatGlow 12s ease-in-out infinite alternate;
      z-index:0; pointer-events:none;
    }
    @keyframes floatGlow{ from{transform:translateY(0) scale(1);opacity:.9;} to{transform:translateY(-30px) scale(1.05);opacity:.7;} }

    /* Sidebar */
    .sidebar{ display:flex; flex-direction:column; padding-top:.25rem; }
    @media (min-width:880px){
      .sidebar{
        position:fixed; top:0; left:0; width:260px; height:100vh;
        background:rgba(10,16,32,0.65);
        border-right:1px solid rgba(255,255,255,0.05);
        backdrop-filter: blur(18px);
        z-index:5;
      }
      main.console, footer{ margin-left:260px; }
    }
    @media (max-width:879px){
      .sidebar{
        position:fixed; left:-100%; top:0; width:75%; height:100vh;
        background:rgba(10,16,32,0.95);
        transition:transform .3s ease, left .3s ease; z-index:20;
      }
      body.nav-open .sidebar{ left:0; }
    }

    .brand{ display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem .05rem; }
    .brand img{
      width:72px; height:auto; aspect-ratio:1/1; object-fit:contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));
      transition: transform .25s, filter .25s;
    }
    .brand img:hover{ transform:scale(1.05); filter: drop-shadow(0 0 12px rgba(91,208,255,0.9)); }
    .logo-text{
      background: linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      font-weight:700; font-size:1.35rem;
    }

    .vnav{ list-style:none; padding:0; margin:.05rem 1rem .75rem; }
    .vnav li{ margin-bottom:.42rem; }
    .vnav a{
      color:#cfd9ff; text-decoration:none; display:block;
      padding:.6rem 1rem; border-radius:10px;
      transition: background .2s, color .2s;
    }
    .vnav a:hover,.vnav a.active-link{
      background: rgba(91,208,255,0.15); color: var(--accent);
      box-shadow: 0 0 12px rgba(91,208,255,0.12);
    }

    .sidebar .cta-primary{
      display:block; margin:1rem; margin-top:auto; width:calc(100% - 2rem);
      background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#0a1020;
      border:none; border-radius:10px; padding:.6rem; font-weight:800; cursor:pointer;
      transition: transform .25s;
    }
    .sidebar .cta-primary:hover{ transform: translateY(-2px); }

    /* Danger button (Shutdown) */
    .cta-danger{
      background:linear-gradient(90deg,#ff6b6b,#ff3b3b);
      color:#0a1020; font-weight:800; padding:.6rem 1.4rem;
      border:none; border-radius:10px; cursor:pointer;
      box-shadow:0 0 12px rgba(255,107,107,0.25); transition:.2s;
      width:calc(100% - 2rem); margin:0 1rem 1rem;
    }
    .cta-danger:hover{ filter:brightness(1.1); }
    .cta-danger:disabled{ opacity:.6; cursor:not-allowed; }

    /* Hamburger for mobile */
    .hamburger{
      position:fixed; top:12px; left:16px; z-index:30;
      background:rgba(255,255,255,0.08); color:#eaf0ff;
      border:1px solid rgba(255,255,255,0.12); border-radius:10px;
      padding:.45rem .65rem; cursor:pointer; display:none;
      backdrop-filter: blur(8px);
    }
    @media(max-width:879px){ .hamburger{ display:block; } }

    /* Floating Shutdown FAB (always visible) */
    .shutdown-fab{
      position:fixed; right:18px; bottom:18px; z-index:30;
      background:linear-gradient(90deg,#ff6b6b,#ff3b3b);
      color:#0a1020; border:none; border-radius:999px;
      padding:.75rem 1rem; font-weight:800; cursor:pointer;
      box-shadow:0 6px 20px rgba(255,107,107,0.35);
    }
    .shutdown-fab:disabled{ opacity:.6; cursor:not-allowed; }

    /* Main */
    main.console{
      position:relative; z-index:2; padding:3rem 3rem 5rem;
      animation: fadeRise 1s ease; display:flex; flex-direction:column; align-items:center;
    }
    @keyframes fadeRise{ from{opacity:0; transform:translateY(25px);} to{opacity:1; transform:translateY(0);} }

    h1.page-title{
      font-size:2.4rem; font-weight:800;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-align:center; margin-bottom:.6rem;
    }
    .muted{ color:var(--muted); text-align:center; max-width:720px; margin-bottom:2rem; }

    .form-wrapper{
      width:100%; max-width:900px;
      background:var(--panel); border:1px solid rgba(255,255,255,0.05);
      border-radius:16px; padding:2rem;
      box-shadow:0 0 25px rgba(91,208,255,0.08);
      backdrop-filter:blur(10px);
    }

    form{ display:flex; flex-direction:column; gap:1.2rem; }
    label{ font-weight:600; color:#dce4ff; }

    textarea{
      width:100%; border-radius:10px; min-height:160px;
      background:rgba(0,0,0,.25); color:#eaf0ff;
      border:1px solid var(--stroke); padding:12px; font-size:15px; resize:vertical;
    }

    .options-row{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:.8rem; }

    .toggle{ display:flex; align-items:center; gap:.4rem; }
    .switch{ position:relative; width:48px; height:26px; }
    .switch input{ opacity:0; width:0; height:0; }
    .slider{ position:absolute; inset:0; cursor:pointer; background:#444; border-radius:26px; transition:.3s; }
    .slider:before{ content:""; position:absolute; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:.3s; }
    input:checked + .slider{ background:var(--accent); }
    input:checked + .slider:before{ transform:translateX(22px); }
    .toggle-label{ font-size:13px; color:var(--muted); }

    .cta-buttons{ display:flex; gap:.8rem; justify-content:flex-end; margin-top:.5rem; }
    .cta-primary{
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#0a1020; font-weight:800; padding:.6rem 1.4rem;
      border:none; border-radius:10px; cursor:pointer;
      box-shadow:0 0 12px rgba(91,208,255,0.25); transition:.2s;
    }
    .cta-primary:hover{ filter:brightness(1.2); }
    .cta-secondary{
      background:rgba(255,255,255,0.08); color:#eaf0ff;
      border:1px solid rgba(255,255,255,0.12); border-radius:10px;
      padding:.6rem 1.4rem; cursor:pointer;
    }

    footer{
      text-align:center; padding:2rem 1rem;
      color:#9aa7cc; border-top:1px solid rgba(255,255,255,0.05);
      backdrop-filter:blur(10px); font-size:.9rem;
      margin-left:260px;
    }

    @media(max-width:960px){
      .sidebar{ width:200px; }
      main.console, footer{ margin-left:200px; padding:2rem; }
    }
    @media(max-width:700px){
      .sidebar{ display:none; }
      main.console, footer{ margin-left:0; padding:1.5rem; }
    }
  </style>
</head>

<body class="page-enter">
  <!-- mobile hamburger -->
  <button id="nav-toggle" class="hamburger" aria-label="Toggle navigation" aria-controls="sidebar" aria-expanded="false">‚ò∞</button>

  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>

    <ul class="vnav">
      <li><a href="/index.html" class="active-link" aria-current="page">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>

    <button class="cta-primary" type="button" onclick="document.getElementById('jd').focus()">üöÄ Get Started</button>
    <!-- Shutdown button in sidebar -->
    <button id="shutdown-btn" class="cta-danger" type="button" title="Stop ASTRA server">‚èª Shutdown Server</button>
  </aside>

  <main class="console" role="main">
    <h1 class="page-title">HIREX ‚Äî High Resume eXpert</h1>
    <p class="muted">
      Paste your <strong>Job Description</strong> below. HIREX uses your canonical
      <code>base_resume.tex</code> to produce an ATS-safe, JD-aligned version.
    </p>

    <div class="form-wrapper">
      <form id="optimize-form" novalidate>
        <label for="jd">Job Description</label>
        <textarea id="jd" name="jd" placeholder="Paste full job description here‚Ä¶" required aria-required="true"></textarea>

        <div class="options-row">
          <div class="toggle">
            <label class="switch" aria-label="Enable Humanize API">
              <input type="checkbox" id="humanize_toggle_main" />
              <span class="slider" aria-hidden="true"></span>
            </label>
            <span class="toggle-label">Enable Humanize API</span>
          </div>

          <div class="cta-buttons">
            <button type="submit" class="cta-primary">üöÄ Optimize Resume</button>
            <button type="reset" class="cta-secondary">Reset</button>
          </div>
        </div>

        <input type="hidden" id="use_humanize_state" name="use_humanize" value="false" />
      </form>
    </div>
  </main>

  <footer>
    ¬© 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>OpenAI</strong> + <strong>LaTeX</strong>
  </footer>

  <!-- Toast container for unified UI layer -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Always-visible Shutdown FAB -->
  <button id="shutdown-fab" class="shutdown-fab" type="button" aria-label="Shutdown server">‚èª</button>

  <!-- Load utilities and UI helpers before main logic -->
  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>
  <script src="/static/js/main.js?v=2.1.2" defer></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.getElementById("humanize_toggle_main");
      const hidden = document.getElementById("use_humanize_state");

      // Read both new (on/off) and legacy (true/false) keys; default ON
      const a = localStorage.getItem("hirex-use-humanize");     // "on" | "off"
      const b = localStorage.getItem("hirex_use_humanize");     // "true" | "false"
      const startOn = (a === "on") || (b === "true") || (a === null && b === null);

      toggle.checked = startOn;
      hidden.value = startOn ? "true" : "false";

      toggle.addEventListener("change", () => {
        const on = toggle.checked;
        // Persist in both formats for backward/forward compatibility
        localStorage.setItem("hirex-use-humanize", on ? "on" : "off");
        localStorage.setItem("hirex_use_humanize", on ? "true" : "false");
        hidden.value = on ? "true" : "false";
        document.dispatchEvent(new CustomEvent("hirex:humanize-change", { detail: { on } }));
        (window.HIREX?.toast || ((m)=>alert(m)))(on ? "üßë‚Äçüíº Humanize Enabled" : "‚öôÔ∏è Optimize Only");
      });

      // Mobile nav toggle
      const navToggle = document.getElementById("nav-toggle");
      navToggle?.addEventListener("click", () => {
        const on = !document.body.classList.contains("nav-open");
        document.body.classList.toggle("nav-open", on);
        navToggle.setAttribute("aria-expanded", String(on));
      });

      // Unified shutdown handler for both buttons
      const wireShutdown = (btn) => {
        if (!btn) return;
        btn.addEventListener("click", async () => {
          if (!confirm("Shut down the ASTRA server now?")) return;
          const prevText = btn.textContent;
          btn.disabled = true;
          if (btn.id === "shutdown-btn") btn.textContent = "‚èª Shutting down‚Ä¶";
          try {
            const res = await fetch("/api/system/shutdown", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ reason: "user_request" })
            });
            if (!res.ok) throw new Error("Shutdown endpoint failed");
            (window.HIREX?.toast || ((m)=>alert(m)))("üõë Server shutting down‚Ä¶");
            setTimeout(() => {
              window.close();
              window.location.href = "about:blank";
            }, 800);
          } catch (e) {
            (window.HIREX?.toast || ((m)=>alert(m)))("‚ö†Ô∏è Couldn‚Äôt reach shutdown endpoint.");
            btn.disabled = false;
            btn.textContent = prevText;
          }
        });
      };

      wireShutdown(document.getElementById("shutdown-btn"));
      wireShutdown(document.getElementById("shutdown-fab"));
    });
  </script>
</body>
</html>

/* FILE: ./dashboard.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>Dashboard | ASTRA ‚Äî AI Career Analytics v2.1.2</title>
  <meta name="description" content="Interactive analytics dashboard tracking optimizations, cover letters, SuperHuman activity, MasterMind chats, and Talk sessions across the ASTRA suite." />
  <meta name="author" content="Sri Akash Kadali" />

  <!-- CSP: CDN Chart.js, blob: previews, workers, localhost websockets -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self' blob: data: https: http://127.0.0.1:8000 ws://127.0.0.1:8000 http://0.0.0.0:8000 ws://0.0.0.0:8000 https://cdn.jsdelivr.net;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root{
      --bg:#0a1020;--panel:rgba(255,255,255,0.05);--muted:rgba(255,255,255,0.7);
      --accent:#5bd0ff;--accent2:#a678ff;--radius:14px;--glow:0 0 25px rgba(91,208,255,0.25);
    }

    /* Futuristic background */
    body{
      background: radial-gradient(circle at 25% 20%, #0a1020 0%, #03060f 80%);
      color:#e4ecff;font-family:"Inter","Segoe UI",Roboto,sans-serif;overflow-x:hidden;
      line-height:1.6;position:relative;min-height:100vh;margin:0;
    }
    ::selection{ background:var(--accent); color:#000; }
    .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

    body::before{
      content:"";position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);
    }
    body::after{
      content:"";position:fixed;width:500px;height:500px;top:30%;right:10%;z-index:0;pointer-events:none;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);filter: blur(70px);
      animation: floatGlow 10s ease-in-out infinite alternate;
    }
    @keyframes floatGlow{ from{transform:translateY(0) scale(1);opacity:.9;} to{transform:translateY(-40px) scale(1.05);opacity:.7;} }

    .menu-toggle,.theme-toggle{display:none!important;}

    /* Sidebar */
    .sidebar{display:flex;flex-direction:column;padding-top:.25rem;}
    @media (min-width:880px){
      .sidebar{position:fixed;top:0;left:0;width:260px;height:100vh;background:rgba(10,16,32,0.65);
        border-right:1px solid rgba(255,255,255,0.05);backdrop-filter: blur(18px);z-index:5;}
      main.console,footer{margin-left:260px;}
    }
    @media (max-width:879px){
      .sidebar{position:fixed;left:-100%;top:0;width:70%;height:100vh;background:rgba(10,16,32,0.95);
        transition:transform .3s ease;z-index:20;}
      body.nav-open .sidebar{transform:translateX(100%);}
    }

    .brand{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem .05rem;}
    .brand img{width:72px;height:auto;aspect-ratio:1/1;object-fit:contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));transition:transform .25s, filter .25s;}
    .brand img:hover{transform:scale(1.05);filter: drop-shadow(0 0 12px rgba(91,208,255,0.9));}
    .logo-text{font-weight:700;font-size:1.35rem;background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:.5px;}
    .vnav{list-style:none;padding:0;margin:.05rem 1rem 1rem;}
    .vnav li{margin-bottom:.42rem;}
    .vnav a{color:#cfd9ff;text-decoration:none;display:block;padding:.6rem 1rem;border-radius:10px;transition:background .2s,color .2s;}
    .vnav a:hover,.vnav a.active-link{background: rgba(91,208,255,0.15); color: var(--accent);}

    /* Main */
    main.console{position:relative;z-index:2;padding:3rem 3rem 5rem;animation:fadeRise 1s ease;}
    h1.page-title{font-size:2.3rem;font-weight:700;text-align:center;margin-bottom:.6rem;
      background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:1px;}
    .muted{color:var(--muted);text-align:center;margin:0 auto 2rem;max-width:700px;}

    .toolbar{display:flex;align-items:center;justify-content:flex-end;gap:.6rem;margin:-.5rem 0 1.25rem;}
    .btn{border:1px solid rgba(255,255,255,0.14);background:rgba(10,16,32,0.85);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px;transition:background .2s, transform .15s;}
    .btn:hover{background:rgba(255,255,255,0.08);transform:translateY(-1px);}
    #dashboard-status{color:var(--muted);font-size:.9rem;}

    /* Metric cards */
    .cards-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px;margin-bottom:2.5rem;}
    .metric{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:18px;text-align:center;transition:transform .25s, box-shadow .25s;position:relative;overflow:hidden;}
    .metric:hover{transform:translateY(-4px);box-shadow:0 0 35px rgba(91,208,255,0.25);}
    .metric::before{content:"";position:absolute;inset:0;background:linear-gradient(135deg,transparent,rgba(91,208,255,0.15));opacity:0;transition:opacity .3s;}
    .metric:hover::before{opacity:1;}
    .metric .num{font-size:2rem;color:var(--accent);font-weight:600;}
    .metric .label{color:var(--muted);font-size:.9rem;}

    /* Charts */
    .chart-section{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:1.5rem;margin-bottom:2.5rem;
      box-shadow:0 0 20px rgba(91,208,255,0.08);backdrop-filter:blur(10px);transition:transform .3s, box-shadow .3s;}
    .chart-section:hover{transform:translateY(-4px);box-shadow:0 0 30px rgba(91,208,255,0.25);}
    .chart-section h2{text-align:center;font-size:1.1rem;margin-bottom:.8rem;background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:.5px;}
    .chart-section canvas{display:block;margin:0 auto;width:100%;max-width:900px;height:320px!important;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);}

    /* Footer */
    footer{text-align:center;padding:2rem 1rem;font-size:.9rem;color:#9aa7cc;border-top:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);z-index:2;position:relative;}
    footer a{color:var(--accent);text-decoration:none;} footer a:hover{text-decoration:underline;}

    @keyframes fadeRise{ from{opacity:0; transform:translateY(25px);} to{opacity:1; transform:translateY(0);} }

    @media (max-width:880px){
      .brand{padding:.5rem 1rem .04rem}.brand img{width:60px}.logo-text{font-size:1.2rem}.vnav{margin:.02rem 1rem 1rem}
    }
  </style>
</head>

<body class="page-enter" data-app="astra">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html" class="active-link" aria-current="page">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main id="content" class="console" role="main">
    <div class="main-inner">
      <h1 class="page-title anim rise">üìä Dashboard Analytics</h1>
      <p class="muted">AI-powered insights across <strong>Optimizations</strong>, <strong>Cover Letters</strong>, <strong>SuperHuman</strong>, <strong>MasterMind</strong>, and <strong>Talk Sessions</strong>.</p>

      <div class="toolbar" aria-label="Dashboard controls">
        <button class="btn" id="dashboard-refresh" type="button">‚Üª Refresh</button>
        <span id="dashboard-status" aria-live="polite">Idle</span>
      </div>

      <!-- Metrics -->
      <section class="cards-row anim fade" aria-label="High-level metrics">
        <div class="metric"><div class="num" id="opt_count">0</div><div class="label">Optimizations</div></div>
        <div class="metric"><div class="num" id="cl_count">0</div><div class="label">Cover Letters</div></div>
        <div class="metric"><div class="num" id="hm_count">0</div><div class="label">SuperHuman Calls</div></div>
        <div class="metric"><div class="num" id="mm_count">0</div><div class="label">MasterMind Chats</div></div>
        <div class="metric"><div class="num" id="talk_count">0</div><div class="label">Talk Queries</div></div>
      </section>

      <!-- Charts -->
      <section class="chart-section" aria-labelledby="h_opt"><h2 id="h_opt">üìÑ Resume Optimizations</h2><canvas id="chart_optimizations"></canvas></section>
      <section class="chart-section" aria-labelledby="h_cl"><h2 id="h_cl">‚úâÔ∏è Cover Letter Generation</h2><canvas id="chart_coverletters"></canvas></section>
      <section class="chart-section" aria-labelledby="h_sh"><h2 id="h_sh">‚ú® SuperHuman Refinements</h2><canvas id="chart_superhuman"></canvas></section>
      <section class="chart-section" aria-labelledby="h_mm"><h2 id="h_mm">üß† MasterMind Insights</h2><canvas id="chart_mastermind"></canvas></section>
      <section class="chart-section" aria-labelledby="h_talk"><h2 id="h_talk">üí¨ Talk Queries</h2><canvas id="chart_talk"></canvas></section>
    </div>
  </main>

  <footer>
    &copy; 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>Chart.js</strong> + <strong>OpenAI</strong>
  </footer>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Scripts: Chart.js first, then util/ui, then dashboard logic -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>
  <script src="/static/js/dashboard.js?v=2.1.2" defer></script>

  <!-- Fallback inline charts (only if dashboard.js didn't render / no backend).
       Guards against double-render by checking Chart.getChart(...) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (!window.Chart) return;

      const maybeInit = (id, init) => {
        const el = document.getElementById(id);
        if (!el) return;
        const existing = (Chart.getChart ? Chart.getChart(el) : null);
        if (existing) return; // already rendered by dashboard.js
        const ctx = el.getContext("2d");
        init(ctx);
      };

      const gradient = (ctx, a, b) => { const g = ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,a); g.addColorStop(1,b); return g; };
      const baseOptions = {
        plugins:{ legend:{ display:false } },
        scales:{
          x:{ ticks:{ color:"#bbb" }, grid:{ color:"rgba(255,255,255,0.06)" } },
          y:{ ticks:{ color:"#888" }, grid:{ color:"rgba(255,255,255,0.06)" } }
        }
      };
      const labels = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

      maybeInit("chart_optimizations", (ctx) => new Chart(ctx, {
        type:"line",
        data:{ labels, datasets:[{
          label:"Optimizations", data:[5,9,6,4,7,3,8],
          borderColor:"rgba(91,208,255,0.8)", backgroundColor:gradient(ctx,"rgba(91,208,255,0.8)","rgba(159,120,255,0.3)"),
          fill:true, tension:0.4
        }]},
        options: baseOptions
      }));

      maybeInit("chart_coverletters", (ctx) => new Chart(ctx, {
        type:"bar",
        data:{ labels, datasets:[{
          label:"Cover Letters", data:[3,6,5,7,4,8,5],
          borderColor:"rgba(255,184,77,0.8)", backgroundColor:gradient(ctx,"rgba(255,184,77,0.8)","rgba(255,107,107,0.3)")
        }]},
        options: baseOptions
      }));

      maybeInit("chart_superhuman", (ctx) => new Chart(ctx, {
        type:"line",
        data:{ labels, datasets:[{
          label:"SuperHuman", data:[8,5,6,7,9,4,5],
          borderColor:"rgba(121,255,207,0.8)", backgroundColor:gradient(ctx,"rgba(121,255,207,0.8)","rgba(91,208,255,0.3)"),
          fill:true, tension:0.4
        }]},
        options: baseOptions
      }));

      maybeInit("chart_mastermind", (ctx) => new Chart(ctx, {
        type:"bar",
        data:{ labels, datasets:[{
          label:"MasterMind", data:[2,4,3,5,6,4,7],
          borderColor:"rgba(173,91,255,0.8)", backgroundColor:gradient(ctx,"rgba(173,91,255,0.8)","rgba(91,208,255,0.3)")
        }]},
        options: baseOptions
      }));

      maybeInit("chart_talk", (ctx) => new Chart(ctx, {
        type:"line",
        data:{ labels, datasets:[{
          label:"Talk", data:[7,9,5,6,8,4,7],
          borderColor:"rgba(255,107,107,0.8)", backgroundColor:gradient(ctx,"rgba(255,107,107,0.8)","rgba(255,184,77,0.3)"),
          fill:true, tension:0.4
        }]},
        options: baseOptions
      }));
    });
  </script>
</body>
</html>

/* FILE: ./talk.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>Talk to HIREX | ASTRA ‚Äî AI Career Assistant v2.1.3</title>
  <meta name="description" content="Ask job or interview questions ‚Äî HIREX responds using your saved resume and job description pair." />
  <meta name="author" content="Sri Akash Kadali" />

  <!-- CSP aligned with suite: dev websockets, blobs, workers, about: iframes -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self' blob: http://127.0.0.1:8000 ws://127.0.0.1:8000 http://0.0.0.0:8000 ws://0.0.0.0:8000 http://localhost:8000 ws://localhost:8000 https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          font-src 'self' data:;
          media-src 'self' blob: data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="preload" href="/static/assets/logo.png" as="image" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.3" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.3" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.3" />

  <style>
    :root {
      --bg: #0a0f1a;
      --panel: #101622;
      --accent: #5bd0ff;
      --accent2: #9f78ff;
      --muted: rgba(255,255,255,0.7);
      --radius: 12px;
      --font: "Inter","Outfit",system-ui,sans-serif;
      --sidebar-width: 260px;
      --history-width: 240px;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #e6ecf7;
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      position: relative;
      z-index: 0;
      line-height: 1.6;
    }
    ::selection { background: var(--accent); color: #000; }
    .menu-toggle, .theme-toggle { display: none !important; }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);
      animation: gridFloat 24s linear infinite;
      pointer-events: none;
      z-index: -1;
    }
    body::after {
      content: "";
      position: fixed;
      width: 500px;
      height: 500px;
      top: 30%;
      right: 10%;
      background: radial-gradient(circle, rgba(91,208,255,0.12), transparent 70%);
      filter: blur(100px);
      animation: glowPulse 10s ease-in-out infinite alternate;
      pointer-events: none;
      z-index: -1;
    }
    @keyframes gridFloat { from { background-position: 0 0, 0 0; } to { background-position: 80px 80px, 80px 80px; } }
    @keyframes glowPulse { from { opacity: .8; transform: scale(1); } to { opacity: .6; transform: scale(1.1); } }

    /* Sidebar */
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      width: var(--sidebar-width);
      background: rgba(10,16,32,0.9);
      border-right: 1px solid rgba(255,255,255,0.05);
      z-index: 10; backdrop-filter: blur(10px);
      display: flex; flex-direction: column; padding-top: .25rem;
    }
    .brand { display: flex; align-items: center; gap: .75rem; padding: .6rem 1rem .05rem; }
    .brand img {
      width: 72px; height: auto; aspect-ratio: 1 / 1; object-fit: contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));
      transition: transform .25s ease, filter .25s ease;
    }
    .brand img:hover { transform: scale(1.05); filter: drop-shadow(0 0 12px rgba(91,208,255,0.9)); }
    .logo-text {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; background-clip: text;
      color: transparent; font-weight: 700; font-size: 1.35rem; letter-spacing: .4px;
    }

    .vnav { list-style: none; padding: 0; margin: .05rem 1rem 1rem; }
    .vnav li { margin-bottom: .42rem; }
    .vnav a {
      display: block; padding: 0.6rem 1rem; color: #cfd9ff; border-radius: 10px; text-decoration: none;
      transition: background .2s ease, color .2s ease;
    }
    .vnav a:hover, .vnav a.active-link { background: rgba(91,208,255,0.12); color: var(--accent); }

    /* History panel */
    #history-panel {
      position: fixed; left: var(--sidebar-width); top: 0; bottom: 0;
      width: var(--history-width);
      background: rgba(10,16,32,0.9);
      border-right: 1px solid rgba(255,255,255,0.05);
      padding: 1rem; overflow-y: auto; z-index: 9; backdrop-filter: blur(10px);
    }
    #history-panel h3 {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      font-size: 1rem; text-align: center; margin-bottom: 0.75rem; font-weight: 700; letter-spacing: .3px;
    }
    #history-list { list-style: none; margin: 0; padding: 0; }
    #history-list li {
      padding: .6rem .5rem; border-radius: 8px; color: #ccc; cursor: pointer;
      transition: background .2s ease, color .2s ease;
    }
    #history-list li:hover, #history-list li.active { background: rgba(91,208,255,0.18); color: #fff; }

    /* Main */
    main.console {
      margin-left: calc(var(--sidebar-width) + var(--history-width));
      padding: 2.5rem 3rem 4rem;
      max-width: 1000px; position: relative; z-index: 1;
      display: flex; flex-direction: column; gap: 1.8rem; animation: fadeRise 1s ease;
    }
    @keyframes fadeRise { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

    h1.page-title {
      text-align: center; font-size: 2rem; font-weight: 600;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      margin-bottom: 0.5rem;
    }
    .muted { text-align: center; color: var(--muted); margin-bottom: 2rem; }

    /* Card */
    .card {
      background: var(--panel); border: 1px solid rgba(255,255,255,0.07);
      border-radius: var(--radius); padding: 1.5rem;
      transition: transform .25s ease, box-shadow .25s ease;
      position: relative; z-index: 2; box-shadow: 0 0 20px rgba(91,208,255,0.08);
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(91,208,255,0.22); }

    label {
      font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;
      text-align: center; text-transform: uppercase; letter-spacing: 0.4px;
    }
    select, textarea {
      width: 100%; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12);
      background: #0e1424; color: #eaf0ff; padding: 10px 12px; font-size: 14px; outline: none;
      transition: border-color .25s, background .25s;
    }
    select:focus, textarea:focus { border-color: var(--accent); background: #111a30; }
    select option { background: #0f1628; color: #eaf0ff; }

    .btn {
      border: none; background: var(--accent); color: #0a0f1a; padding: 10px 14px;
      border-radius: 8px; font-weight: 600; cursor: pointer; transition: background .25s, transform .15s;
    }
    .btn:hover { background: #72d7ff; transform: translateY(-1px); }

    /* Chat */
    .chat-box {
      background: #0f1524; border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px; padding: 14px; overflow-y: auto; height: 65vh;
    }
    .msg { margin-bottom: 12px; max-width: 85%; font-size: 14px; line-height: 1.5;
      padding: 10px 14px; border-radius: 8px; white-space: pre-wrap; word-break: break-word; }
    .msg.user { background: #18243c; color: #eaf0ff; margin-left: auto; }
    .msg.bot  { background: #141b2e; color: #dce4f8; }

    .chat-controls { display: flex; gap: 10px; align-items: flex-start; margin-top: 12px; }
    .chat-controls textarea { flex: 1; min-height: 60px; border-radius: 8px; }

    footer {
      text-align: center; color: #9aa7cc; font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.06);
      padding: 1.5rem; margin-top: 3rem; position: relative; z-index: 2;
    }

    /* Responsive */
    @media(max-width:1100px){
      #history-panel { display: none; }
      main.console { margin-left: var(--sidebar-width); }
    }
    @media(max-width:880px){
      .brand { padding: .5rem 1rem .04rem; }
      .brand img { width: 60px; }
      .logo-text { font-size: 1.2rem; }
      .vnav { margin: .02rem 1rem 1rem; }
    }
    @media(max-width:700px){
      main.console { padding: 1.5rem; }
      .chat-box { height: 60vh; }
    }
  </style>
</head>

<body class="page-enter" data-app="astra">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html" aria-current="page" class="active-link">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- JD/Resume History Sidebar -->
  <aside id="history-panel" aria-label="Saved JD and Resume History">
    <h3>üìú JD + Resume History</h3>
    <ul id="history-list"></ul>
  </aside>

  <!-- Main -->
  <main id="content" class="console" role="main">
    <h1 class="page-title anim rise">Talk to HIREX</h1>
    <p class="muted">
      Ask job or interview questions ‚Äî HIREX responds using your saved
      <strong>resume</strong> and <strong>job description</strong> pair.
    </p>

    <!-- Context selection -->
    <section class="card anim fade" aria-labelledby="context-label">
      <label id="context-label" for="contextSelect">Select JD + Resume</label>
      <select id="contextSelect" aria-label="JD and Resume selection"></select>
      <div style="text-align:center;margin-top:1rem;">
        <button class="btn" id="loadContext" type="button">Load Context</button>
        <div id="contextStatus" style="font-size:13px;margin-top:8px;color:var(--muted);" aria-live="polite">Idle</div>
      </div>
    </section>

    <!-- Chat -->
    <section class="card anim fade" aria-label="Chat with HIREX">
      <div id="talk-chat" class="chat-box" aria-live="polite">
        <div class="msg bot">üëã Hi! I‚Äôm HIREX ‚Äî ask anything about your role, JD, or fit.</div>
      </div>
      <div class="chat-controls" id="talk-form" role="form" aria-label="Ask HIREX">
        <textarea id="talk-input" placeholder="e.g., 'What makes me a strong fit for this position?'" aria-label="Your question"></textarea>
        <button class="btn" id="talk-send" type="button" aria-label="Send question">Ask</button>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>OpenAI</strong>
  </footer>

  <div id="toast" role="status" aria-live="polite" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f1524;border:1px solid rgba(255,255,255,0.08);padding:10px 14px;border-radius:8px;z-index:50;"></div>

  <script src="/static/js/util.js?v=2.1.3" defer></script>
  <script src="/static/js/ui.js?v=2.1.3" defer></script>
  <script src="/static/js/talk.js?v=2.1.3" defer></script>

  <script>
    // ===== Utilities =====
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const esc = (v) => String(v ?? "‚Äî").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = (msg, ms=2400) => { const t=$("#toast"); if(!t) return; t.textContent=msg; t.style.display="block"; clearTimeout(window.__t0); window.__t0=setTimeout(()=>t.style.display="none", ms); };
    const setStatus = (s)=>{ const el=$("#contextStatus"); if(el) el.textContent=s; };

    // Stable key for selection dedupe
    const keyFrom = (obj) => {
      if (obj?.key) return String(obj.key).toLowerCase();
      const c = (obj?.company || obj?.company_name || "").toLowerCase().trim().replace(/\s+/g,"_");
      const r = (obj?.role || "").toLowerCase().trim().replace(/\s+/g,"_");
      return `${c}__${r}`;
    };
    const dedupeByKey = (items) => {
      const seen = new Set(); const out = [];
      for (const it of items) {
        const k = keyFrom(it);
        if (!k || seen.has(k)) continue;
        seen.add(k);
        out.push({
          ...it,
          company: it.company || it.company_name || "‚Äî",
          role: it.role || it.title || "‚Äî",
          __key: k
        });
      }
      return out;
    };

    // ===== Backend API (v2.x) =====
    async function listContexts(limit=200) {
      const r = await fetch(`/api/context/list?limit=${limit}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Failed to list contexts");
      const j = await r.json();
      return Array.isArray(j.items) ? j.items : [];
    }
    async function getContextByKey(key) {
      const r = await fetch(`/api/context/get?key=${encodeURIComponent(key)}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Context not found");
      return await r.json();
    }
    async function getLatestContext() {
      const r = await fetch(`/api/context/get?latest=1`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("No latest context");
      return await r.json();
    }

    // ===== Persist selection for talk.js & other pages =====
    function persistSelectedContext(ctx) {
      const selected = {
        key: keyFrom(ctx),
        company: ctx.company || ctx.company_name || "",
        role: ctx.role || ctx.title || "",
        jd_text: (ctx.jd_text || ctx.jd || ""),
        resume_tex: (ctx.humanized?.tex || ctx.humanized_tex || ctx.optimized?.tex || ctx.resume_tex || ""),
        pdf_base64: ctx.pdf_base64 || "",
        pdf_base64_humanized: ctx.pdf_base64_humanized || ""
      };
      try {
        localStorage.setItem("hirex_selected_context", JSON.stringify(selected));
        localStorage.setItem("hirex_company", selected.company);
        localStorage.setItem("hirex_role", selected.role);
      } catch {}
      return selected;
    }

    function renderHistoryList(container, items) {
      container.innerHTML = items.map(it =>
        `<li data-key="${esc(it.__key)}" tabindex="0" role="button" aria-label="Select ${esc(it.company)} ‚Äî ${esc(it.role)}">${esc(it.company)} ‚Äî ${esc(it.role)}</li>`
      ).join("");
    }
    function populateSelect(select, items) {
      if (!items.length) {
        select.innerHTML = `<option disabled selected>No saved JD + Resume</option>`;
        return;
      }
      select.innerHTML = items.map(it =>
        `<option value="${esc(it.__key)}">${esc(it.company)} ‚Äî ${esc(it.role)}</option>`
      ).join("");
    }

    // ===== Boot =====
    document.addEventListener("DOMContentLoaded", async () => {
      const select  = $("#contextSelect");
      const list    = $("#history-list");
      const loadBtn = $("#loadContext");

      try {
        setStatus("Loading history‚Ä¶");
        const items = await listContexts(300);
        const uniq  = dedupeByKey(items);

        populateSelect(select, uniq);
        renderHistoryList(list, uniq);

        // Preselect previously chosen context (if exists)
        const prev = (() => { try { return JSON.parse(localStorage.getItem("hirex_selected_context")||"null"); } catch { return null; }})();
        if (prev?.key) {
          select.value = prev.key;
          [...list.children].forEach(li => li.classList.toggle("active", li.dataset.key === prev.key));
        } else if (uniq.length) {
          select.value = uniq[0].__key;
          [...list.children].forEach((li, i) => li.classList.toggle("active", i === 0));
          // Auto-persist newest once so chat works out of the box
          try {
            const ctx = await getContextByKey(uniq[0].__key);
            persistSelectedContext(ctx);
          } catch {}
        } else {
          // Backend empty ‚Äî fallback to local history (best-effort)
          const localHist = (() => { try { return JSON.parse(localStorage.getItem("hirex_history")||"[]"); } catch { return []; }})();
          const dedupLocal = dedupeByKey(localHist);
          populateSelect(select, dedupLocal);
          renderHistoryList(list, dedupLocal);
        }

        // Click on sidebar history selects the item
        list.addEventListener("click", (e) => {
          const li = e.target.closest("li"); if (!li) return;
          const key = li.dataset.key;
          select.value = key;
          [...list.children].forEach(x => x.classList.remove("active"));
          li.classList.add("active");
        });
        // Keyboard select
        list.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            const li = e.target.closest("li"); if (!li) return;
            li.click();
          }
        });

        // Load button: fetch by key and persist
        loadBtn.addEventListener("click", async () => {
          const key = select.value;
          if (!key) return toast("Please select a JD + Resume pair.");
          setStatus("Loading context‚Ä¶");
          try {
            const ctx = await getContextByKey(key);
            const saved = persistSelectedContext(ctx);
            setStatus(`‚úÖ Loaded: ${saved.company || "‚Äî"} ‚Äî ${saved.role || "‚Äî"}`);
            toast("Context loaded.");
          } catch (e) {
            setStatus("‚ö†Ô∏è Failed to load context");
            toast(String(e));
          }
        });

        setStatus("Idle");
      } catch (e) {
        // If backend listing fails, try to at least get the latest context directly
        try {
          const ctx = await getLatestContext();
          const saved = persistSelectedContext(ctx);
          populateSelect($("#contextSelect"), [{company:saved.company, role:saved.role, __key:saved.key}]);
          renderHistoryList($("#history-list"), [{company:saved.company, role:saved.role, __key:saved.key}]);
          setStatus(`‚òÅÔ∏è Loaded latest: ${saved.company} ‚Äî ${saved.role}`);
        } catch {
          setStatus("History unavailable");
          $("#contextSelect").innerHTML = `<option disabled selected>History unavailable</option>`;
          $("#history-list").innerHTML  = `<li>No history yet</li>`;
        }
      }

      (window.ASTRA ?? window.HIREX)?.debugLog?.("TALK PAGE LOADED", { version: "v2.1.3" });
    });
  </script>
</body>
</html>

/* FILE: ./genie.html */

<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>üßû Genie | ASTRA ‚Äî Guide & FAQ v2.1.2</title>
  <meta name="description" content="Genie ‚Äî unified About + Help for the ASTRA suite. Includes HIREX quick start, FAQs, credits, and architecture." />
  <meta name="author" content="Sri Akash Kadali" />
  <meta property="og:title" content="ASTRA ‚Äî Genie (About + Help)" />
  <meta property="og:description" content="Unified guide for ASTRA: HIREX (resume optimizer), MasterMind (assistant), SuperHuman (humanizer)." />
  <meta property="og:image" content="/static/assets/og-preview.png" />

  <!-- CSP allows local dev (HTTP/WS), data/blob previews, and OpenAI for images (if needed) -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self'
                       blob:
                       http://127.0.0.1:8000 ws://127.0.0.1:8000
                       http://0.0.0.0:8000 ws://0.0.0.0:8000
                       http://localhost:8000 ws://localhost:8000
                       https://api.openai.com
                       https://cdn.jsdelivr.net;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root {
      --bg:#0a1020;
      --accent:#5bd0ff;
      --accent2:#9f78ff;
      --panel:rgba(255,255,255,0.05);
      --muted:rgba(255,255,255,0.7);
      --stroke:rgba(255,255,255,0.08);
      --radius:14px;
      --glow:0 0 25px rgba(91,208,255,0.25);
    }
    body {
      margin:0;
      background: radial-gradient(circle at 25% 22%, var(--bg) 0%, #03060f 80%) fixed;
      color:#e4ecff;
      font-family:"Inter","Segoe UI",Roboto,sans-serif;
      line-height:1.6;
      overflow-x:hidden;
      min-height:100vh;
      position:relative;
      text-align:left;
    }
    ::selection { background: var(--accent); color:#000; }
    body::before {
      content:"";
      position:fixed; inset:0;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.035) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.035) 0 1px, transparent 1px 80px);
      pointer-events:none; z-index:0;
    }
    body::after {
      content:"";
      position:fixed; width:420px; height:420px; top:18%; right:10%;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);
      filter: blur(65px); animation: floatGlow 10s ease-in-out infinite alternate;
      pointer-events:none; z-index:0;
    }
    @keyframes floatGlow {
      from { transform:translateY(0); opacity:.9; }
      to   { transform:translateY(-36px); opacity:.75; }
    }

    .menu-toggle, .theme-toggle { display:none !important; }

    /* Sidebar */
    .sidebar {
      position:fixed; top:0; left:0; width:260px; height:100vh;
      background:rgba(10,16,32,0.65);
      border-right:1px solid var(--stroke);
      backdrop-filter:blur(18px);
      display:flex; flex-direction:column;
      padding-top:.25rem; z-index:5;
    }
    @media(max-width:880px){
      .sidebar{left:-100%;width:70%;background:rgba(10,16,32,0.95);transition:transform .3s ease;}
      body.nav-open .sidebar{transform:translateX(100%);}
    }

    .brand { display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem .05rem; }
    .brand img { width:72px; aspect-ratio:1/1; filter:drop-shadow(0 0 6px rgba(91,208,255,.6)); transition:.25s; }
    .brand img:hover { transform:scale(1.05); filter:drop-shadow(0 0 10px rgba(91,208,255,.9)); }
    .logo-text { font-weight:700; font-size:1.35rem; background:linear-gradient(90deg,var(--accent),var(--accent2)); background-clip:text; -webkit-background-clip:text; color:transparent; }

    .vnav { list-style:none; margin:.4rem 1rem 1rem; padding:0; }
    .vnav li { margin-bottom:.4rem; }
    .vnav a { display:block; padding:.55rem 1rem; color:#cfd9ff; text-decoration:none; border-radius:10px; transition:.2s; }
    .vnav a:hover,.vnav a.active-link { background:rgba(91,208,255,0.15); color:var(--accent); }

    .cta-primary {
      margin:1rem; margin-top:auto; border:none;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#fff; font-weight:600; border-radius:10px;
      padding:.6rem; cursor:pointer; transition:.2s;
    }
    .cta-primary:hover { opacity:.9; }

    /* Main */
    main.console {
      position:relative; z-index:2;
      padding:3rem 3rem 5rem;
      margin-left:260px;
      animation:fadeRise .8s ease;
      display:flex !important;
      flex-direction:column !important;
      align-items:stretch !important;
      justify-content:flex-start !important;
      flex-wrap:nowrap !important;
      text-align:left;
    }
    @keyframes fadeRise { from{opacity:0;transform:translateY(25px);} to{opacity:1;transform:none;} }
    main.console > * { width:100% !important; max-width:100% !important; float:none !important; display:block !important; }

    .page-title {
      font-size:2.2rem; font-weight:700;
      text-align:left;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      background-clip:text; -webkit-background-clip:text; color:transparent;
      margin-bottom:.6rem;
    }
    .muted {
      color:var(--muted);
      max-width:760px;
      margin:0 0 2rem 0;
      text-align:left;
    }

    section.card {
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:1.6rem 1.8rem;
      margin-bottom:2rem;
      box-shadow:var(--glow);
      backdrop-filter:blur(10px);
      transition:transform .25s ease, box-shadow .25s ease;
      display:block !important;
      text-align:left;
    }
    section.card:hover { transform:translateY(-3px); box-shadow:0 0 36px rgba(91,208,255,.25); }
    section.card h2 {
      font-size:1.25rem;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      background-clip:text; -webkit-background-clip:text; color:transparent;
      margin-bottom:.8rem;
      text-align:left;
    }

    details {
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1);
      border-radius:10px; padding:.8rem 1rem; margin:.6rem 0; transition:.25s;
      text-align:left;
    }
    details[open]{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.2);}
    summary{font-weight:600;font-size:1rem;color:#fff;list-style:none;cursor:pointer; text-align:left;}
    details p{margin-top:.6rem;color:var(--muted);font-size:.95rem;}

    footer {
      text-align:left; padding:2rem 1rem; font-size:.9rem; color:#9aa7cc;
      border-top:1px solid var(--stroke); backdrop-filter:blur(10px);
    }

    @media(max-width:880px){
      main.console{margin-left:0;padding:2rem 1.4rem 4rem;}
    }

    .btn-row { display:flex; gap:.6rem; flex-wrap:wrap; margin:.8rem 0 0; }
    .btn {
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:#e4ecff; padding:.45rem .7rem; border-radius:10px;
      font-weight:600; cursor:pointer;
      text-align:left;
    }
    .btn:hover{background:rgba(255,255,255,.1);}
    code.k { background:rgba(255,255,255,.08); padding:.06rem .35rem; border-radius:6px; }
    .kv { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.92rem; }
    #status_text { transition: opacity .3s ease; }
  </style>
</head>

<body class="page-enter" data-app="astra">
  <a href="#content" class="sr-only">Skip to content</a>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html" class="active-link" aria-current="page">üßû Genie</a></li>
    </ul>
    <button class="cta-primary" onclick="window.location.href='mailto:sriakashkadali@gmail.com'">üìß Contact Support</button>
  </aside>

  <!-- Main -->
  <main class="console" id="content" role="main">
    <h1 class="page-title">üßû Genie ‚Äî Guide & FAQ</h1>
    <p class="muted">
      <strong>ASTRA</strong> (Automated System for Tailored Resume Applications): <strong>HIREX</strong> is the resume optimizer,
      <strong>SuperHuman</strong> is a standalone humanizer, and <strong>MasterMind</strong> is a standalone assistant
      with no resume dependency.
    </p>

    <!-- STATUS -->
    <section class="card" id="status_card" aria-live="polite">
      <h2>üü¢ System Status</h2>
      <p id="status_text">Checking FastAPI backend‚Ä¶</p>
      <ul id="status_meta" class="muted" style="margin-top:.6rem;"></ul>
      <div class="btn-row">
        <button class="btn" id="btn_diag">Copy diagnostics</button>
        <button class="btn" id="btn_clear">Clear local cache</button>
        <button class="btn" id="btn_ping">Ping API</button>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="card">
      <h2>‚ÑπÔ∏è About ASTRA</h2>
      <p>Under the ASTRA umbrella:</p>
      <ul>
        <li><strong>HIREX ‚Äî High Resume eXpert</strong>: AI-driven LaTeX resume optimization aligned to a given JD.</li>
        <li><strong>SuperHuman ‚Äî Humanizer</strong>: Standalone text polishing and tone refinement (not resume-specific).</li>
        <li><strong>MasterMind</strong>: Standalone ChatGPT-class assistant for research, coding, writing, and more.</li>
        <li><strong>Cover Letter</strong>: Personalized cover-letter generation powered by HIREX context.</li>
      </ul>
    </section>

    <!-- QUICK START -->
    <section class="card">
      <h2>üöÄ Quick Start (HIREX)</h2>
      <ol>
        <li>Open the <a href="/index.html">Home</a> page.</li>
        <li>Paste your <strong>Job Description (JD)</strong>.</li>
        <li>(Optional) Enable <strong>Humanize</strong> for tone refinement.</li>
        <li>Click <em>‚ÄúOptimize Resume‚Äù</em>.</li>
        <li>View or download results via <a href="/preview.html">Preview</a>.</li>
      </ol>
      <p class="muted kv">Tip: Server memory lets you reload previous Company/Role runs from <code class="k">/api/context</code> without re-pasting.</p>
    </section>

    <!-- FAQ -->
    <section class="card">
      <h2>üí° Common Questions (HIREX)</h2>
      <details open>
        <summary>What file formats are supported?</summary>
        <p>LaTeX (<code>.tex</code>) inputs with PDF outputs.</p>
      </details>
      <details>
        <summary>Can I change the base resume?</summary>
        <p>Yes. Replace <code>data/samples/base_resume.tex</code>; subsequent runs will use it.</p>
      </details>
      <details>
        <summary>What does ‚ÄúHumanize‚Äù do?</summary>
        <p>It refines fluency, tone, and clarity while keeping content truthful.</p>
      </details>
    </section>

    <!-- API -->
    <section class="card">
      <h2>üõ∞Ô∏è API Endpoints (v2.1.x)</h2>
      <ul class="kv">
        <li><code>GET /health</code> ‚Äî Service heartbeat (also exposed via app version). <small class="muted">Compat: trailing slash ok</small></li>
        <li><code>GET /api/utils/ping</code> ¬∑ <code>GET /api/utils/version</code> ¬∑ <code>GET /api/utils/config</code> ¬∑ <code>POST /api/utils/log</code> ‚Äî Diagnostics & telemetry.</li>
        <li><code>POST /api/optimize</code> <small class="muted">Primary</small> ‚Äî JD ‚Üí Optimized resume (LaTeX/PDF). <small class="muted">Compat aliases: <code>/api/optimize/run</code>, <code>/api/optimize/submit</code></small></li>
        <li><code>POST /api/coverletter</code> ‚Äî JD + base CL ‚Üí Cover Letter (LaTeX/PDF).</li>
        <li><code>POST /api/superhuman/rewrite</code> ‚Äî Text rewrite (LaTeX-safe).</li>
        <li><code>POST /api/talk/answer</code> <small class="muted">alias</small> & <code>POST /api/talk</code> ‚Äî JD-aware Q&amp;A; loads from Context if provided.</li>
        <li><code>POST /api/mastermind/start</code> ¬∑ <code>POST /api/mastermind/chat</code> ¬∑ <code>GET /api/mastermind/history</code> ¬∑ <code>GET /api/mastermind/sessions</code> ‚Äî MasterMind chat flows.</li>
        <li><code>GET /api/context/list</code> ¬∑ <code>GET /api/context/get</code> ¬∑ <code>POST /api/context/save</code> ‚Äî Stable server memory (key: <code>{company}__{role}</code>).</li>
        <li><code>GET /api/dashboard</code> ¬∑ <code>/summary</code> ‚Äî Analytics summary + trends + history.</li>
      </ul>
    </section>

    <!-- ARCHITECTURE -->
    <section class="card">
      <h2>üß© Architecture & Technology</h2>
      <ol class="kv">
        <li><strong>Frontend:</strong> Modular Vanilla JS (v2.1.x) with state persistence.</li>
        <li><strong>Backend:</strong> FastAPI microservices handling AI inference and LaTeX rendering.</li>
        <li><strong>AI Core:</strong> OpenAI GPT-5 / GPT-4o-mini (configurable defaults).</li>
        <li><strong>Data Layer:</strong> JSONL analytics and filesystem session/context stores.</li>
        <li><strong>Security:</strong> Sandboxed TeX compilation and LaTeX-safe input escaping.</li>
      </ol>
    </section>

    <!-- DATA -->
    <section class="card">
      <h2>üíæ Data & Storage</h2>
      <p class="muted">Client-side keys used across modules:</p>
      <ul class="kv">
        <li><code>hirex_history</code> ‚Äî chronological actions</li>
        <li><code>hirex_tex</code>, <code>hirex_pdf</code>, <code>hirex_pdf_humanized</code></li>
        <li><code>hirex_company</code>, <code>hirex_role</code>, <code>hirex_fit_score</code></li>
        <li><code>hirex_jd_text</code>, <code>hirex_use_humanize</code></li>
        <li><code>hirex_rating_history</code>, <code>hirex_coverage_ratio</code> (if available)</li>
      </ul>
    </section>

    <!-- CREDITS -->
    <section class="card">
      <h2>üí° Credits & Development</h2>
      <ul class="kv">
        <li>üë®‚Äçüíª <strong>Developer:</strong> Sri Akash Kadali</li>
        <li>üè´ <strong>Institution:</strong> University of Maryland, College Park</li>
        <li>üß≠ <strong>Vision:</strong> Merge AI automation with human creativity</li>
        <li>‚öôÔ∏è <strong>Stack:</strong> FastAPI ¬∑ Python ¬∑ LaTeX ¬∑ OpenAI API ¬∑ Vanilla JS ¬∑ HTML ¬∑ CSS</li>
      </ul>
    </section>

    <!-- LICENSE -->
    <section class="card">
      <h2>üìú License & Usage</h2>
      <p>
        HIREX v2.1.x is released under the <strong>MIT License</strong>.<br />
        Free for academic and personal use. Attribution to <strong>Sri Akash Kadali</strong> is appreciated for derivative or commercial applications.
      </p>
    </section>
  </main>

  <footer>
    ¬© 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>LaTeX</strong>
  </footer>

  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>
  <script>
    // ---- Utilities ----------------------------------------------------------
    async function fetchJSON(url, opts = {}, ms = 7000) {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), ms);
      try {
        const res = await fetch(url, { ...opts, signal: ctrl.signal, cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } finally {
        clearTimeout(timer);
      }
    }

    // like fetchJSON, but keeps headers (for 'Date' header fallback)
    async function fetchJSONRaw(url, opts = {}, ms = 7000) {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), ms);
      try {
        const res = await fetch(url, { ...opts, signal: ctrl.signal, cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        return { json, res };
      } finally {
        clearTimeout(timer);
      }
    }

    function getApiBase() {
      const host = location.hostname;
      if (["127.0.0.1","0.0.0.0","localhost"].includes(host)) return "http://127.0.0.1:8000";
      return (window.HIREX && typeof HIREX.getApiBase === "function") ? HIREX.getApiBase() : location.origin;
    }

    function clearLocalCache() {
      const keys = Object.keys(localStorage).filter(k => k.startsWith("hirex_"));
      keys.forEach(k => localStorage.removeItem(k));
      alert("Local cache cleared (" + keys.length + " keys).");
    }

    // Robust date parser for various Python/HTTP formats
    function parseServerDate(val) {
      if (!val) return NaN;
      let s = String(val).trim();

      // If header date (RFC 7231), let Date.parse handle it
      if (/^[A-Za-z]{3}, \d{2} /.test(s)) {
        const t = Date.parse(s);
        return isNaN(t) ? NaN : t;
      }

      // Normalize: "YYYY-MM-DD HH:MM:SS(.micro)[+TZ]" -> "YYYY-MM-DDTHH:MM:SS(.ms)Z?"
      if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/.test(s)) {
        s = s.replace(" ", "T");
      }
      // Trim microseconds to milliseconds
      s = s.replace(/(\.\d{3})\d+/, "$1");

      // If ISO without timezone, assume UTC
      if (/^\d{4}-\d{2}-\d{2}T/.test(s) && !/[zZ]|[+\-]\d{2}:?\d{2}$/.test(s)) {
        s += "Z";
      }

      const t = Date.parse(s);
      return isNaN(t) ? NaN : t;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const statusText = document.getElementById("status_text");
      const statusMeta = document.getElementById("status_meta");
      const base = getApiBase();
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";

      // Wire buttons
      document.getElementById("btn_clear")?.addEventListener("click", clearLocalCache);
      document.getElementById("btn_ping")?.addEventListener("click", async () => {
        try {
          const p = await fetchJSON(`${base}/api/utils/ping`);
          alert(`Ping OK: ${p.status} (${p.platform} ¬∑ py ${p.python})`);
        } catch (e) {
          alert("Ping failed: " + (e && e.message || e));
        }
      });
      document.getElementById("btn_diag")?.addEventListener("click", async () => {
        try {
          const [v, c] = await Promise.allSettled([
            fetchJSON(`${base}/api/utils/version`),
            fetchJSON(`${base}/api/utils/config`)
          ]);
          const payload = {
            when: new Date().toISOString(),
            base,
            version: v.value || null,
            config: (c.value && c.value.config) || null
          };
          await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
          alert("Diagnostics copied to clipboard.");
        } catch {
          alert("Could not copy diagnostics.");
        }
      });

      // Status: try /health then enrich with /api/utils/version + /ping
      try {
        // Use RAW to access headers for 'Date' fallback
        const { json: health, res: healthRes } = await fetchJSONRaw(`${base}/health/`);
        const ver  = await fetchJSON(`${base}/api/utils/version`).catch(() => ({}));
        const ping = await fetchJSON(`${base}/api/utils/ping`).catch(() => ({}));

        const appV = (ver && ver.version) || (health && health.version) || "2.1.x";
        statusText.textContent = `Backend OK ‚Äî v${appV}`;

        statusMeta.innerHTML = `
          <li><strong>Status:</strong> ${health.status || "ok"}</li>
          <li><strong>Time:</strong> <span id="server_time">‚Äî</span>
              <small class="muted" id="time_note"></small>
              <small class="muted">¬∑ ${tz}</small></li>
          <li><strong>API Base:</strong> ${base}</li>
          <li><strong>Platform:</strong> ${ping.platform || "‚Äî"} ¬∑ py ${ping.python || "‚Äî"}</li>
          <li><strong>Default Model:</strong> ${(ver && ver.default_model) || "‚Äî"}</li>`;

        // ---- Live server-time clock (robust against odd formats) -------------
        const candidates = [
          health?.time,
          ver?.build_time,
          healthRes?.headers?.get("date") // RFC7231 HTTP-date fallback
        ];

        let serverEpochMs = NaN;
        for (const c of candidates) {
          const t = parseServerDate(c);
          if (!Number.isNaN(t)) { serverEpochMs = t; break; }
        }

        const timeEl = document.getElementById("server_time");
        const noteEl = document.getElementById("time_note");

        let timeOffsetMs = 0;
        if (!Number.isNaN(serverEpochMs)) {
          timeOffsetMs = serverEpochMs - Date.now();
          noteEl.textContent = "Live";
        } else {
          // Fall back to local clock so we never show "Invalid Date"
          timeOffsetMs = 0;
          noteEl.textContent = "Live (Local Clock)";
        }

        function renderServerClock() {
          if (!timeEl) return;
          const now = new Date(Date.now() + timeOffsetMs);
          timeEl.textContent = now.toLocaleString();
        }
        renderServerClock();
        setInterval(renderServerClock, 1000);

        // Re-sync from server every 60 seconds to avoid drift
        setInterval(async () => {
          try {
            const { json: h2, res: h2Res } = await fetchJSONRaw(`${base}/health/`);
            const nextCandidates = [h2?.time, h2Res?.headers?.get("date")];
            let nextMs = NaN;
            for (const c of nextCandidates) {
              const t = parseServerDate(c);
              if (!Number.isNaN(t)) { nextMs = t; break; }
            }
            if (!Number.isNaN(nextMs)) {
              timeOffsetMs = nextMs - Date.now();
              if (noteEl) noteEl.textContent = "auto-updating (server-synced)";
            }
          } catch (_) { /* ignore periodic re-sync errors */ }
        }, 60000);

      } catch (e) {
        statusText.textContent = "Backend check failed (offline or CORS).";
        statusMeta.innerHTML = `<li><strong>Error:</strong> ${(e && e.message) || "Unknown"}</li>
          <li><strong>API Base:</strong> ${base}</li>`;
      }
    });
  </script>
</body>
</html>

/* FILE: ./superhuman.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>SuperHuman | ASTRA ‚Äî Humanizer v2.1.0</title>
  <meta name="description" content="SuperHuman ‚Äî ASTRA‚Äôs standalone Humanizer to refine any text for tone, clarity, and flow. No resume or JD context required." />
  <meta name="author" content="Sri Akash Kadali" />

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self' blob: http://127.0.0.1:8000 ws://127.0.0.1:8000 http://0.0.0.0:8000 ws://0.0.0.0:8000 https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          font-src 'self' data:;
          media-src 'self' blob: data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="preload" href="/static/assets/logo.png" as="image" />
  <link rel="preconnect" href="https://api.openai.com" crossorigin />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.0" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.0" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.0" />

  <style>
    :root {
      --bg:#0a1020; --panel:rgba(255,255,255,0.05); --muted:rgba(255,255,255,0.7);
      --accent:#5bd0ff; --accent2:#a678ff; --radius:14px; --stroke:rgba(255,255,255,0.08);
      --sidebar-w:260px;
    }

    body {
      background: radial-gradient(circle at 25% 20%, #0a1020 0%, #03060f 80%) fixed;
      color:#e4ecff; font-family:"Inter","Segoe UI",Roboto,sans-serif;
      line-height:1.6; margin:0; min-height:100vh; overflow-x:hidden; position:relative;
    }
    ::selection { background:var(--accent); color:#000; }

    /* decorative grid overlay */
    body::before {
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);
    }
    body::after {
      content:""; position:fixed; width:460px; height:460px; top:25%; right:8%;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);
      filter: blur(68px); animation: glow 10s ease-in-out infinite alternate;
      pointer-events:none; z-index:0;
    }
    @keyframes glow {
      from { transform:translateY(0) scale(1); opacity:.9; }
      to   { transform:translateY(-36px) scale(1.05); opacity:.75; }
    }

    .menu-toggle,.theme-toggle{display:none!important;}

    /* Sidebar (unified 260px) */
    .sidebar {
      position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh;
      background:rgba(10,16,32,0.65); border-right:1px solid var(--stroke);
      backdrop-filter:blur(18px); z-index:5; display:flex; flex-direction:column; padding-top:.25rem;
    }
    @media(max-width:879px){
      .sidebar{ left:-100%; width:70%; background:rgba(10,16,32,0.95); transition:transform .3s ease; }
      body.nav-open .sidebar{ transform:translateX(100%); }
    }

    .brand{ display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem .05rem; }
    .brand img{
      width:72px; aspect-ratio:1/1; object-fit:contain;
      filter:drop-shadow(0 0 6px rgba(91,208,255,.6)); transition:transform .25s, filter .25s;
    }
    .brand img:hover{ transform:scale(1.05); filter:drop-shadow(0 0 12px rgba(91,208,255,.9)); }
    .logo-text{
      font-weight:700; font-size:1.35rem;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:transparent; -webkit-background-clip:text; background-clip:text;
    }

    .vnav{ list-style:none; padding:0; margin:.05rem 1rem 1rem; }
    .vnav li{ margin-bottom:.42rem; }
    .vnav a{
      display:block; padding:.6rem 1rem; color:#cfd9ff; text-decoration:none;
      border-radius:10px; transition:background .2s, color .2s;
    }
    .vnav a:hover, .vnav a.active-link{ background:rgba(91,208,255,0.15); color:var(--accent); }

    /* Mobile hamburger */
    .hamburger{
      position:fixed; top:12px; left:16px; z-index:30;
      background:rgba(255,255,255,0.08); color:#eaf0ff;
      border:1px solid rgba(255,255,255,0.12); border-radius:10px;
      padding:.45rem .65rem; cursor:pointer; display:none;
      backdrop-filter: blur(8px);
    }
    @media(max-width:879px){ .hamburger{ display:block; } }

    /* Main */
    main.console {
      position:relative; z-index:2; display:flex; flex-direction:column; gap:1.5rem;
      padding:2.2rem 2.4rem 4rem; margin-left:var(--sidebar-w); animation:fadeRise .8s ease;
    }
    @keyframes fadeRise { from{opacity:0; transform:translateY(18px);} to{opacity:1; transform:translateY(0);} }
    @media(max-width:879px){ main.console{ margin-left:0; padding:1.5rem 1.25rem 4rem; } }

    .page-title {
      font-size:2.2rem; font-weight:800; text-align:center; margin:.2rem 0 .6rem;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:transparent; -webkit-background-clip:text; background-clip:text;
    }
    .muted{ color:var(--muted); text-align:center; margin:0 auto; max-width:760px; }

    /* Toolbar */
    .toolbar {
      display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; justify-content:center;
      background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:.6rem;
      box-shadow:0 0 20px rgba(91,208,255,.08); backdrop-filter:blur(10px); margin:0 auto; max-width:1200px;
    }
    .toolbar select,.toolbar button,.toolbar label{
      height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(15,22,40,0.9); color:#eaf0ff; padding:0 10px; font-size:13px;
    }
    .toolbar .primary{
      background:var(--accent); color:#0a1020; border:none; font-weight:700;
      box-shadow:0 0 16px rgba(91,208,255,.2); cursor:pointer; padding:0 14px;
    }
    .toolbar .primary:hover{ background:#72d7ff; }
    .toolbar .ghost{ background:transparent; border:1px dashed rgba(255,255,255,.18); cursor:pointer; }
    .toolbar .status{ color:var(--muted); font-size:13px; padding:0 6px; }

    /* Toggle switch */
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; inset: 0; background-color: #444; border-radius: 26px; transition: .3s;
    }
    .slider:before {
      position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
      background-color: white; border-radius: 50%; transition: .3s;
    }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(24px); }
    .toggle-label { font-size: 13px; color: var(--muted); margin-left: 8px; }

    /* Split panes */
    .split { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:0 auto; max-width:1200px; }
    @media (max-width:980px){ .split{ grid-template-columns:1fr; } }

    .pane {
      display:flex; flex-direction:column; gap:8px; background:var(--panel); border:1px solid var(--stroke);
      border-radius:14px; padding:10px; box-shadow:0 0 20px rgba(91,208,255,.08); backdrop-filter:blur(10px);
    }
    .pane .head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:2px 2px 0; }
    .pane .head .title{ font-weight:700; color:#eaf0ff; }
    .pane .head .actions{ display:flex; gap:6px; flex-wrap:wrap; }

    .btn{ height:32px; padding:0 10px; border-radius:8px; border:1px solid rgba(255,255,255,.12);
      background:#0f1628; color:#eaf0ff; font-size:13px; cursor:pointer; }
    .btn:hover{ background:rgba(255,255,255,.08); }

    .editor,.output {
      flex:1; min-height:420px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.2); padding:12px; color:#e6ecff; font-size:14.5px; line-height:1.6;
      outline:none; overflow:auto; white-space:pre-wrap; word-break:break-word;
    }
    textarea.editor{ resize:vertical; }
    .hint{ color:var(--muted); font-size:12px; text-align:right; }

    footer{ text-align:center; padding:2rem 1rem; font-size:.9rem; color:#9aa7cc;
      border-top:1px solid var(--stroke); backdrop-filter:blur(10px); }
  </style>
</head>

<body class="page-enter" data-app="astra">
  <!-- Mobile hamburger -->
  <button id="nav-toggle" class="hamburger" aria-label="Toggle navigation" aria-controls="sidebar" aria-expanded="false">‚ò∞</button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html" class="active-link" aria-current="page">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- Main Section -->
  <main id="content" class="console" role="main">
    <h1 class="page-title">SuperHuman ‚Äî Humanizer</h1>
    <p class="muted">Top to bottom flow ‚Äî input/output remain side-by-side. Perfect for large content refinement.</p>

    <!-- Toolbar -->
    <div class="toolbar" role="toolbar" aria-label="Humanizer controls">
      <select id="mode" aria-label="Rewrite mode">
        <option value="paragraph" selected>Paragraph</option>
        <option value="sentence">Sentence</option>
        <option value="resume">Resume Bullet</option>
        <option value="coverletter">Cover Letter</option>
        <option value="custom">Custom</option>
      </select>

      <select id="tone" aria-label="Tone">
        <option value="balanced" selected>Balanced</option>
        <option value="formal">Formal</option>
        <option value="confident">Confident</option>
        <option value="conversational">Conversational</option>
        <option value="academic">Academic</option>
      </select>

      <label for="latex_safe">
        <input type="checkbox" id="latex_safe" checked /> LaTeX-safe
      </label>

      <!-- Global Humanize Toggle -->
      <label class="switch" title="Toggle Humanize API">
        <input type="checkbox" id="humanize_toggle" checked />
        <span class="slider"></span>
      </label>
      <span class="toggle-label">Humanize API</span>

      <button id="rewrite_btn" class="primary" type="button">‚ö° Humanize</button>
      <button id="clear_btn" class="ghost" type="button">üßπ Clear</button>
      <span class="status" id="status_badge" aria-live="polite">üü¢ Humanize ON</span>
    </div>

    <!-- Input / Output -->
    <section class="split" aria-label="Humanizer editor and output">
      <div class="pane">
        <div class="head">
          <div class="title">‚úçÔ∏è Input</div>
          <div class="actions">
            <button id="paste_btn" class="btn" type="button" aria-controls="input_text">üìã Paste</button>
            <span class="hint"><span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">Enter</span> to Humanize</span>
          </div>
        </div>
        <textarea id="input_text" class="editor" placeholder="Paste or type text to humanize‚Ä¶" spellcheck="false"></textarea>
      </div>

      <div class="pane">
        <div class="head">
          <div class="title">üß† Humanized</div>
          <div class="actions">
            <button id="copy_btn" class="btn" type="button">üìÑ Copy</button>
            <button id="download_btn" class="btn" type="button">‚¨áÔ∏è Download</button>
            <button id="select_btn" class="btn" type="button">üîé Select all</button>
          </div>
        </div>
        <div id="human_output" class="output" contenteditable="true" role="textbox" aria-multiline="true" tabindex="0">(output appears here)</div>
        <div class="hint">Editable area ‚Äî tweak and copy instantly.</div>
      </div>
    </section>
  </main>

  <footer>
    ¬© 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>AI Humanize API</strong>
  </footer>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Scripts -->
  <script src="/static/js/util.js?v=2.1.0" defer></script>
  <script src="/static/js/ui.js?v=2.1.0" defer></script>
  <!-- Align with latest SuperHuman engine (v2.1.2) -->
  <script src="/static/js/superhuman.js?v=2.1.2" defer></script>

  <!-- Page-only helper actions -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Mobile nav toggle
      const navToggle = document.getElementById("nav-toggle");
      navToggle?.addEventListener("click", () => {
        const on = !document.body.classList.contains("nav-open");
        document.body.classList.toggle("nav-open", on);
        navToggle.setAttribute("aria-expanded", String(on));
      });

      const H = window.HIREX || {};
      const outEl = document.getElementById("human_output");
      const inputEl = document.getElementById("input_text");
      const getOutText = () => (outEl?.innerText || outEl?.textContent || "").trim();

      // Copy
      document.getElementById("copy_btn")?.addEventListener("click", async () => {
        const text = getOutText();
        if (!text) return (H.toast ? H.toast("‚ö†Ô∏è Nothing to copy.") : alert("Nothing to copy."));
        try { await navigator.clipboard.writeText(text); H.toast?.("üìã Copied to clipboard!"); }
        catch { (H.toast || alert)("‚ö†Ô∏è Clipboard permission denied."); }
      });

      // Select all
      document.getElementById("select_btn")?.addEventListener("click", () => {
        if (!outEl) return;
        const range = document.createRange(); range.selectNodeContents(outEl);
        const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
        H.toast?.("üîé Selected all output.");
      });

      // Download
      document.getElementById("download_btn")?.addEventListener("click", () => {
        const text = getOutText();
        if (!text) return (H.toast ? H.toast("‚ö†Ô∏è Nothing to download.") : alert("Nothing to download."));
        const ts = new Date().toISOString().replace(/[:.]/g,"-");
        const name = `SuperHuman_${ts}.txt`;
        const blob = new Blob([text], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), { href: url, download: name });
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 600);
      });

      // Paste
      document.getElementById("paste_btn")?.addEventListener("click", async () => {
        try {
          const t = await navigator.clipboard.readText();
          if (!t) return H.toast?.("‚ÑπÔ∏è Clipboard is empty.");
          if (inputEl) {
            inputEl.value = (inputEl.value ? inputEl.value + "\n" : "") + t;
            inputEl.focus();
            H.toast?.("üìã Pasted into input.");
          }
        } catch {
          (H.toast || alert)("‚ö†Ô∏è Clipboard permission denied.");
        }
      });

      (window.ASTRA ?? window.HIREX)?.debugLog?.("SUPERHUMAN PAGE LOADED", { version: "v2.1.0" });
    });
  </script>
</body>
</html>

/* FILE: ./coverletter.html */

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>ASTRA ‚Ä¢ HIREX ‚Äî Cover Letter Generator v2.1.2</title>
  <meta name="description" content="Generate a JD-optimized, humanized cover letter using stored job description and LaTeX resume." />
  <meta name="author" content="Sri Akash Kadali" />
  <meta property="og:title" content="ASTRA ‚Ä¢ HIREX ‚Äî Cover Letter Generator v2.1.2" />
  <meta property="og:description" content="Draft and download a JD-specific, LaTeX cover letter with optional tone humanization." />
  <meta property="og:type" content="website" />

  <!-- CSP: allow blob/data for PDFs, workers, dev websockets, and same-origin HTTPS -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self' blob: data: https: http://127.0.0.1:8000 ws://127.0.0.1:8000 http://0.0.0.0:8000 ws://0.0.0.0:8000 https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          media-src 'self' blob: data:;
          font-src 'self' data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.2" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.2" />

  <style>
    :root{
      --bg:#0a1020;--accent:#5bd0ff;--accent2:#a678ff;--muted:rgba(255,255,255,0.7);
      --card-bg:rgba(255,255,255,0.05);--card-border:rgba(255,255,255,0.08);
      --field-bg:#0f152b;
    }
    html, body { background:#0a1020; }
    body{
      background: radial-gradient(circle at 30% 20%, var(--bg) 0%, #03060f 80%) fixed;
      color:#e4ecff;font-family:"Inter","Segoe UI",Roboto,sans-serif;line-height:1.6;margin:0;overflow-x:hidden;
    }
    .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
    ::selection{ background:var(--accent); color:#000; }
    body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
      background:repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
                 repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);}
    body::after{content:"";position:fixed;width:420px;height:420px;top:20%;right:10%;pointer-events:none;z-index:0;
      background: radial-gradient(circle, rgba(91,208,255,0.15), transparent 70%);filter: blur(60px);
      animation: floatGlow 10s ease-in-out infinite alternate;}
    @keyframes floatGlow{ from{transform:translateY(0) scale(1);opacity:.9;} to{transform:translateY(-30px) scale(1.05);opacity:.7;} }
    .menu-toggle,.theme-toggle{display:none!important;}

    /* Sidebar (fixed) */
    .sidebar{position:fixed;top:0;left:0;width:260px;height:100vh;z-index:5;
      display:flex;flex-direction:column;padding-top:.25rem;background:rgba(10,16,32,0.65);
      border-right:1px solid rgba(255,255,255,0.05);backdrop-filter: blur(18px);}
    .brand{display:flex;align-items:center;gap:.75rem;padding:.6rem 1rem .05rem;}
    .brand img{width:72px;height:auto;aspect-ratio:1/1;object-fit:contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));transition:transform .25s, filter .25s;}
    .brand img:hover{transform:scale(1.05);filter: drop-shadow(0 0 12px rgba(91,208,255,0.9));}
    .logo-text{font-weight:700;font-size:1.35rem;background:linear-gradient(90deg,var(--accent),var(--accent2));
      -webkit-background-clip:text;background-clip:text;color:transparent;}
    .vnav{list-style:none;padding:0;margin:.05rem 1rem 1rem;}
    .vnav li{margin-bottom:.42rem;}
    .vnav a{display:block;padding:.6rem 1rem;color:#cfd9ff;text-decoration:none;border-radius:10px;transition:background .2s,color .2s;}
    .vnav a:hover,.vnav a.active-link{background: rgba(91,208,255,0.15); color: var(--accent);}
    .sidebar .cta-primary{display:none;}

    /* Main */
    main.console{position:relative;z-index:2;padding:3rem 3rem 5rem;max-width:1600px;min-height:100vh;margin-left:260px;animation:fadeRise 1s;}
    footer{margin-left:260px;text-align:center;padding:2rem 1rem;color:#9aa7cc;border-top:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);}
    @media (max-width:880px){
      .sidebar{position:fixed;left:-100%;width:70%;transition:transform .3s ease;}
      body.nav-open .sidebar{transform:translateX(100%);}
      main.console,footer{margin-left:0;padding:1.25rem;}
      .brand{padding:.5rem 1rem .04rem}.brand img{width:60px}.logo-text{font-size:1.2rem}.vnav{margin:.02rem 1rem 1rem}
    }

    /* Content */
    .page-title{font-size:2.2rem;font-weight:700;margin-bottom:.6rem;text-align:center;
      background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;letter-spacing:1px;}
    .muted{color:var(--muted);text-align:center;max-width:820px;margin:0 auto 2rem;}

    .form-section{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:1.75rem 2rem;margin-bottom:2rem;
      box-shadow:0 0 25px rgba(91,208,255,0.15);backdrop-filter:blur(14px);position:relative;overflow:hidden;transition:transform .4s, box-shadow .4s;}
    .form-section:hover{transform:translateY(-4px);box-shadow:0 0 35px rgba(91,208,255,0.25);}
    label{font-size:.85rem;color:var(--muted);display:block;margin-bottom:6px;letter-spacing:.3px;}
    select{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:var(--field-bg);
      color:#fff;padding:10px 12px;font-size:14px;transition:border-color .25s, box-shadow .25s;appearance:none;}
    select:focus{border-color:var(--accent);box-shadow:0 0 12px rgba(91,208,255,0.35);outline:none;}
    option{background:var(--field-bg);color:#fff;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    @media (max-width:720px){.row{grid-template-columns:1fr;}}

    .btn{border:1px solid rgba(255,255,255,0.14);background:rgba(10,16,32,0.85);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;
      font-size:14px;letter-spacing:.3px;transition:background .2s, transform .15s;}
    .btn:hover{background:rgba(255,255,255,0.08);transform:translateY(-1px);}
    .btn.accent{border-color:var(--accent);color:var(--accent);box-shadow:0 0 15px rgba(91,208,255,0.15);}
    #meta_badge{margin-left:1rem;color:var(--muted);font-size:.9rem;}

    .preview-section{margin-top:1rem;}
    .tabs{display:flex;gap:.6rem;margin-bottom:.8rem;justify-content:center;flex-wrap:wrap;}
    .tab{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 12px;color:#c9d4ff;
      font-size:14px;cursor:pointer;transition:all .2s;}
    .tab:hover{border-color:var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(91,208,255,0.15);}
    .tab.active{background:var(--accent);color:#000;border:none;box-shadow:0 0 15px rgba(91,208,255,0.25);}
    .pane{height:70vh;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);
      overflow:hidden;backdrop-filter:blur(12px);box-shadow:0 0 18px rgba(91,208,255,0.08);transition:box-shadow .3s;}
    .pane.active{box-shadow:0 0 28px rgba(91,208,255,0.25);}
    .pane pre{margin:0;padding:14px;height:100%;overflow:auto;white-space:pre-wrap;word-break:break-word;
      font-family:"Fira Code",monospace;font-size:13px;color:#dfe7ff;}
    .pdf-frame{width:100%;height:100%;border:none;background:#0b0f1e;border-radius:12px;}

    #historyWrap{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}
    @media (max-width:900px){#historyWrap{grid-template-columns:1fr}}

    #dl_btn{display:none;margin-left:.5rem}
    @keyframes fadeRise{ from{opacity:0; transform:translateY(25px);} to{opacity:1; transform:translateY(0);} }
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(15,21,43,.95);border:1px solid rgba(255,255,255,.1);
      color:#eaf2ff;padding:.6rem .9rem;border-radius:10px;display:none;z-index:9999}
  </style>
</head>

<body class="page-enter" data-app="hirex">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html" class="active-link" aria-current="page">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main id="content" class="console" role="main">
    <div class="main-inner">
      <h1 class="page-title anim rise">‚úâÔ∏è Cover Letter Generator</h1>
      <p class="muted">Select a stored <strong>Job Description + Resume</strong> pair, choose tone/length, and generate a tailored cover letter.</p>

      <section id="cl-form" class="form-section anim blur-rise" aria-labelledby="cl-form-title">
        <h2 id="cl-form-title" class="visually-hidden">Generate Cover Letter</h2>

        <div id="historyWrap">
          <div>
            <label for="historySelect">Select Previous JD + Resume</label>
            <select id="historySelect" aria-label="Previous JD and Resume pairs"></select>
          </div>
          <div>
            <label for="clHistorySelect">Cover Letter History</label>
            <select id="clHistorySelect" aria-label="Previously generated cover letters"></select>
          </div>
        </div>

        <div class="row" style="margin-top:1rem;">
          <div>
            <label for="toneSelect">Tone</label>
            <select id="toneSelect" aria-label="Cover letter tone">
              <option value="balanced" selected>Balanced (recommended)</option>
              <option value="warm">Warm</option>
              <option value="formal">Formal</option>
              <option value="confident">Confident</option>
              <option value="concise">Concise</option>
            </select>
          </div>
          <div>
            <label for="lengthSelect">Length</label>
            <select id="lengthSelect" aria-label="Cover letter length">
              <option value="short">Short (~120‚Äì180 words)</option>
              <option value="standard" selected>Standard (~180‚Äì280 words)</option>
              <option value="long">Long (~300‚Äì400 words)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:1.2rem;text-align:center;">
          <button class="btn accent" id="generate_btn" type="button">Generate Cover Letter</button>
          <button class="btn" id="dl_btn" type="button">Download PDF</button>
          <span id="meta_badge" aria-live="polite">Idle</span>
        </div>
      </section>

      <section class="preview-section anim fade" aria-label="Cover letter outputs">
        <div class="tabs" role="tablist" aria-label="Cover letter preview tabs">
          <button class="tab active" data-tab="pdf" role="tab" aria-selected="true" aria-controls="pane_pdf">üìÑ PDF</button>
          <button class="tab" data-tab="tex" role="tab" aria-selected="false" aria-controls="pane_tex">üßæ LaTeX</button>
          <button class="tab" data-tab="body" role="tab" aria-selected="false" aria-controls="pane_body">üß† Body</button>
        </div>

        <div id="pane_pdf" class="pane active" role="tabpanel">
          <div class="cl-toolbar" style="display:flex;gap:.5rem;justify-content:flex-end;margin:.5rem;">
            <button class="btn accent" id="cl_dl_pdf">‚¨áÔ∏è Download PDF</button>
            <button class="btn" id="cl_dl_tex">‚¨áÔ∏è Download .tex</button>
            <button class="btn" id="cl_copy_tex">üìã Copy LaTeX</button>
            <button class="btn" id="cl_cancel_btn" style="display:none;">‚ùå Cancel</button>
          </div>
          <iframe id="pdf_frame" class="pdf-frame" title="Cover Letter PDF" src="about:blank"></iframe>
        </div>
        <div id="pane_tex" class="pane" role="tabpanel" hidden>
          <pre id="cl-tex-output">(waiting‚Ä¶)</pre>
        </div>
        <div id="pane_body" class="pane" role="tabpanel" hidden>
          <pre id="body_output">(waiting‚Ä¶)</pre>
        </div>
      </section>
    </div>
  </main>

  <footer>
    &copy; 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>OpenAI</strong> + <strong>LaTeX</strong>
  </footer>

  <div id="toast" role="status" aria-live="polite"></div>
  <script src="/static/js/util.js?v=2.1.2" defer></script>
  <script src="/static/js/ui.js?v=2.1.2" defer></script>

  <script>
    // ------- Mini utils -------
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const esc = (v) => String(v ?? "‚Äî").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = (msg, ms=2500) => { const t=$("#toast"); t.textContent=msg; t.style.display="block"; clearTimeout(window.__t0); window.__t0=setTimeout(()=>t.style.display="none", ms); };
    const setBadge = (s)=>{ const b=$("#meta_badge"); if(b) b.textContent=s; };
    const getTS = () => new Date().toISOString().replace(/[:.]/g,"-");
    const sanitize = s => String(s||"file").replace(/[\\/:*?"<>|]+/g,"_").trim() || "file";

    // Robust base64 handling (URL-safe + padding)
    const normalizeB64 = (b64="") => {
      let x = String(b64||"").trim();
      const i = x.indexOf("base64,"); if (i>=0) x = x.slice(i+7);
      x = x.replace(/[\r\n\s]/g,"").replace(/-/g,"+").replace(/_/g,"/");
      const pad = x.length % 4; return pad ? x + "=".repeat(4-pad) : x;
    };
    const safeAtob = (b64) => { try { return atob(normalizeB64(b64)); } catch { return ""; } };
    const b64toBlob = (b64, mime="application/pdf") => {
      const bytes = safeAtob(b64); if (!bytes) return null;
      const len = bytes.length; const arr = new Uint8Array(len);
      for (let i=0;i<len;i++) arr[i] = bytes.charCodeAt(i) & 0xff;
      return new Blob([arr], {type:mime});
    };

    const keyFrom = (obj) => {
      if (obj?.key) return String(obj.key).toLowerCase();
      const c = (obj?.company || "").toLowerCase().trim().replace(/\s+/g,"_");
      const r = (obj?.role || "").toLowerCase().trim().replace(/\s+/g,"_");
      return `${c}__${r}`;
    };

    // De-duplicate by company__role -> keep newest
    function dedupeByKey(items) {
      const seen = new Set();
      const out = [];
      for (const it of items) {
        const k = keyFrom(it);
        if (seen.has(k)) continue;
        seen.add(k);
        out.push({ ...it, __key: k });
      }
      return out;
    }

    // ------- Backend calls (aligned to /api/context v2.x) -------
    async function listContexts(limit=100) {
      const url = `/api/context/list?limit=${limit}`;
      const r = await fetch(url, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Failed to list contexts");
      const data = await r.json();
      return Array.isArray(data.items) ? data.items : [];
    }

    async function getContextByKey(key) {
      const r = await fetch(`/api/context/get?key=${encodeURIComponent(key)}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Context not found");
      return await r.json();
    }

    async function getLatestContext() {
      const r = await fetch(`/api/context/get?latest=1`, { credentials: "same-origin" });
      if (!r.ok) return null;
      try { return await r.json(); } catch { return null; }
    }

    async function saveCoverLetterToContext({ company, role, pdf_b64, tex_string, tone, length }) {
      const fd = new FormData();
      fd.append("company", company || "");
      fd.append("role", role || "");
      // Dual format for compatibility:
      fd.append("cover_letter_pdf_b64", pdf_b64 || "");
      fd.append("cover_letter_tex", tex_string || "");
      fd.append("cover_letter", JSON.stringify({
        tex: tex_string || "",
        pdf_b64: pdf_b64 || "",
        params: { tone, length }
      }));
      const res = await fetch("/api/context/save", { method: "POST", body: fd, credentials: "same-origin" });
      if (!res.ok) {
        let msg = "Failed to save cover letter";
        try { const j = await res.json(); msg = j.detail || msg; } catch {}
        throw new Error(msg);
      }
    }

    // ------- UI helpers -------
    function populatePairsSelect(select, pairs) {
      if (!pairs.length) {
        select.innerHTML = '<option disabled selected>No saved resumes</option>';
        return;
      }
      select.innerHTML = pairs.map(p =>
        `<option value="${esc(p.__key)}">${esc(p.company)} ‚Äî ${esc(p.role)}</option>`
      ).join("");
    }

    function populateCLHistorySelect(select, covers) {
      if (!covers.length) {
        select.innerHTML = '<option disabled selected>No cover letters yet</option>';
        return;
      }
      select.innerHTML = covers.map(p =>
        `<option value="${esc(p.__key)}">${esc(p.company)} ‚Äî ${esc(p.role)}</option>`
      ).join("");
    }

    let lastPdfUrl = "";
    function setPdfUrl(url) {
      const frame = $("#pdf_frame");
      if (!frame) return;
      if (lastPdfUrl) { try { URL.revokeObjectURL(lastPdfUrl); } catch{} }
      lastPdfUrl = url;
      frame.src = `${url}#view=FitH`;
    }

    function ensureToolbarHandlers({ url, tex, company, role }) {
      const btnPdf  = $("#cl_dl_pdf");
      const btnTex  = $("#cl_dl_tex");
      const btnCopy = $("#cl_copy_tex");

      const pdfName = sanitize(`HIREX_CoverLetter_${sanitize(company)}_${sanitize(role)}_${getTS()}.pdf`);
      const texName = sanitize(`HIREX_CoverLetter_${sanitize(company)}_${sanitize(role)}_${getTS()}.tex`);

      if (btnPdf) {
        btnPdf.onclick = async () => {
          try {
            const blob = await fetch(url).then(r=>r.blob());
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = pdfName;
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=>URL.revokeObjectURL(a.href), 600);
          } catch { toast("‚ùå Failed to download PDF."); }
        };
      }
      if (btnTex) {
        btnTex.onclick = () => {
          if (!(tex||"").trim()) return toast("‚ö†Ô∏è No LaTeX to download!");
          const blob = new Blob([tex], {type:"text/plain"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = texName;
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(()=>URL.revokeObjectURL(a.href), 600);
        };
      }
      if (btnCopy) {
        btnCopy.onclick = async () => {
          if (!(tex||"").trim()) return toast("‚ö†Ô∏è No LaTeX to copy!");
          try { await navigator.clipboard.writeText(tex); toast("‚úÖ LaTeX copied!"); }
          catch { toast("‚ö†Ô∏è Clipboard permission denied."); }
        };
      }

      // Legacy "Download PDF" button
      const dl = $("#dl_btn");
      if (dl) {
        dl.style.display = "inline-block";
        dl.onclick = async () => {
          try {
            const blob = await fetch(url).then(r=>r.blob());
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = pdfName;
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(()=>URL.revokeObjectURL(a.href), 600);
          } catch { toast("‚ùå Failed to download PDF."); }
        };
      }
    }

    // Robust BODY extraction (anchors or document env)
    function extractBodyFromTex(tex="") {
      if (!tex) return "";
      const m = tex.match(/^\s*%[-\s]*BODY-START[-\s]*\s*$([\s\S]*?)^\s*%[-\s]*BODY-END[-\s]*\s*$/im);
      if (m) return m[1].trim();
      const d = tex.match(/\\begin\{document\}([\s\S]*?)\\end\{document\}/i);
      if (d) return d[1].trim();
      // Fallback heuristic
      const m2 = tex.match(/Dear[^\n]*?,([\s\S]*?)Sincerely[, ]/i);
      return (m2 ? m2[1] : "").trim();
    }

    function renderOutputs(key, company, role, pdf_b64, tex_string) {
      // PDF
      const blob = b64toBlob(pdf_b64, "application/pdf");
      if (!blob) { toast("‚ö†Ô∏è Invalid PDF data"); return; }
      const url = URL.createObjectURL(blob);
      setPdfUrl(url);

      // TeX + Body
      $("#cl-tex-output").textContent = (tex_string || "").trim() || "(no tex returned)";
      $("#body_output").textContent = extractBodyFromTex(tex_string || "") || "(body not detected)";

      // Wire toolbar
      ensureToolbarHandlers({ url, tex: tex_string || "", company, role });

      // Persist lightweight client history (overwrite latest per key)
      const histKey = "hirex_coverletters";
      const ls = JSON.parse(localStorage.getItem(histKey) || "[]");
      const filtered = ls.filter(x => (x.__key || keyFrom(x)) !== key);
      filtered.unshift({
        __key: key, company, role,
        pdf_base64: pdf_b64, tex_string,
        saved_at: new Date().toISOString()
      });
      localStorage.setItem(histKey, JSON.stringify(filtered.slice(0, 20)));
    }

    // Cancel/timeout plumbing
    let inflightCtrl = null;
    let inflightTimer = null;
    function attachCancel(enable) {
      const btn = $("#cl_cancel_btn");
      if (!btn) return;
      btn.style.display = enable ? "inline-block" : "none";
      btn.onclick = () => {
        if (inflightCtrl) {
          inflightCtrl.abort();
          toast("üõë Generation canceled.");
          setBadge("Canceled");
          attachCancel(false);
          if (inflightTimer) { clearTimeout(inflightTimer); inflightTimer = null; }
        }
      };
    }

    async function generateCoverLetterFromKey(key, tone, length) {
      setBadge("Preparing‚Ä¶");
      const ctx = await getContextByKey(key);

      const company = ctx.company || ctx.company_name || "";
      const role = ctx.role || "";
      const jd = (ctx.jd_text || "").trim();
      const resume = (ctx.humanized?.tex || ctx.humanized_tex || ctx.resume_tex || "").trim();

      if (!jd || !resume) throw new Error("Selected context is missing JD or Resume text.");

      const useHumanize =
        (window.HIREX?.getHumanizeState && window.HIREX.getHumanizeState()) ||
        (localStorage.getItem("hirex_use_humanize") === "true") ||
        (localStorage.getItem("hirex-use-humanize") !== "off"); // default ON

      const fd = new FormData();
      fd.append("jd_text", jd);
      fd.append("resume_tex", resume);
      fd.append("use_humanize", useHumanize ? "true" : "false");
      fd.append("tone", tone);
      fd.append("length", length);

      setBadge("Generating‚Ä¶");
      inflightCtrl = new AbortController();
      inflightTimer = setTimeout(() => inflightCtrl.abort(), 180000); // 3m
      attachCancel(true);

      try {
        const r = await fetch("/api/coverletter", { method:"POST", body: fd, credentials: "same-origin", signal: inflightCtrl.signal });
        if (!r.ok) {
          const err = await r.text().catch(()=>r.statusText);
          throw new Error(err || "Cover letter generation failed.");
        }
        const data = await r.json().catch(()=> ({}));

        const pdf_b64 = data.pdf_base64 || data.cover_letter_pdf_b64 || "";
        const tex_str = data.tex_string || data.cover_letter_tex || "";

        if (!pdf_b64 && !tex_str) throw new Error("Empty cover letter response from backend.");

        // Render immediately
        setBadge("Rendering‚Ä¶");
        renderOutputs(key, company, role, pdf_b64, tex_str);

        // Persist to backend memory
        try {
          await saveCoverLetterToContext({
            company, role, pdf_b64, tex_string: tex_str, tone, length
          });
        } catch (e) {
          console.warn("[HIREX] saveCoverLetterToContext:", e);
        }

        toast(`‚úÖ Cover letter ready for ${company || "Company"}`);
        setBadge("Done");
      } catch (e) {
        if (e.name === "AbortError") {
          toast("‚ö†Ô∏è Generation canceled or timed out (3 min).");
          setBadge("Canceled / Timed out");
        } else {
          toast("‚ùå " + (e.message || "Unexpected error"));
          setBadge("Error");
        }
      } finally {
        if (inflightTimer) { clearTimeout(inflightTimer); inflightTimer = null; }
        inflightCtrl = null;
        attachCancel(false);
      }
    }

    // Tabs wiring (ARIA)
    document.addEventListener("click",(e)=>{
      const tab = e.target.closest(".tab"); if(!tab) return;
      $$(".tab").forEach(t=>{t.classList.remove("active");t.setAttribute("aria-selected","false");});
      tab.classList.add("active"); tab.setAttribute("aria-selected","true");
      ["pdf","tex","body"].forEach(x=>{
        const p=$("#pane_"+x); const on=(x===tab.dataset.tab);
        p.hidden=!on; p.classList.toggle("active", on);
      });
    });

    // ------- Bootstrap -------
    document.addEventListener("DOMContentLoaded", async () => {
      const selectPairs = $("#historySelect");
      const selectCL = $("#clHistorySelect");
      const genBtn = $("#generate_btn");

      try {
        setBadge("Loading history‚Ä¶");
        // 1) List contexts (newest-first)
        const items = await listContexts(200);

        // 2) Dedupe by key (company__role)
        const uniq = dedupeByKey(items);

        // 3) Split: contexts with resumes vs contexts with saved cover letters
        const withCover = uniq.filter(c =>
          !!(c.cover_letter_pdf_b64 || c.cover_letter_tex || c.cover_letter || c.tex_string && c.pdf_base64)
        );

        populatePairsSelect(selectPairs, uniq);
        populateCLHistorySelect(selectCL, withCover);

        // Load a saved CL instantly when chosen
        selectCL.addEventListener("change", async () => {
          const key = selectCL.value;
          if (!key) return;
          setBadge("Loading cover letter‚Ä¶");
          try {
            const c = await getContextByKey(key);
            const pdf = c.cover_letter_pdf_b64 || c.pdf_base64 || "";
            const tex = c.cover_letter_tex || c.tex_string || "";
            if (pdf || tex) {
              const company = c.company || c.company_name || "";
              const role = c.role || "";
              renderOutputs(key, company, role, pdf, tex);
              setBadge("Loaded");
              toast("Loaded saved cover letter.");
              document.querySelector('.tab[data-tab="pdf"]')?.click();
            } else {
              toast("Selected entry has no saved cover letter.");
              setBadge("Idle");
            }
          } catch (e) {
            toast(String(e));
            setBadge("Idle");
          }
        });

        // Generate from selected JD+Resume pair
        genBtn.addEventListener("click", async () => {
          const key = selectPairs.value;
          if (!key) { toast("Please select a JD + Resume pair."); return; }
          genBtn.disabled = true;
          try {
            const tone = $("#toneSelect").value;
            const length = $("#lengthSelect").value;
            await generateCoverLetterFromKey(key, tone, length);
            document.querySelector('.tab[data-tab="pdf"]')?.click();
          } finally {
            genBtn.disabled = false;
          }
        });

        // Auto-load most recent server memory if nothing rendered yet
        try {
          const latest = await getLatestContext();
          if (latest) {
            const pdf = latest.cover_letter_pdf_b64 || latest.cover_letter?.pdf_b64 || latest.pdf_base64 || "";
            const tex = latest.cover_letter_tex || latest.cover_letter?.tex || latest.tex_string || "";
            if (pdf || tex) {
              const key = keyFrom(latest);
              const company = latest.company || latest.company_name || "Company";
              const role = latest.role || "Role";
              renderOutputs(key, company, role, pdf, tex);
              document.querySelector('.tab[data-tab="pdf"]')?.click();
              setBadge("Loaded latest");
              toast("‚òÅÔ∏è Loaded latest cover letter from server memory.");
            }
          }
        } catch (e) {
          console.warn("[HIREX] latest fetch failed:", e);
        }

        setBadge("Idle");
      } catch (e) {
        toast("History load failed ‚Äî check backend.");
        setBadge("Idle");
        // Fallback to local-only cover letters (if any)
        const ls = JSON.parse(localStorage.getItem("hirex_coverletters") || "[]");
        if (ls.length) {
          selectCL.innerHTML = ls.map(x => `<option value="${esc(x.__key)}">${esc(x.company)} ‚Äî ${esc(x.role)}</option>`).join("");
          selectCL.addEventListener("change", () => {
            const it = ls.find(a => a.__key===selectCL.value);
            if (it) renderOutputs(it.__key, it.company, it.role, it.pdf_base64, it.tex_string);
          });
        } else {
          selectCL.innerHTML = '<option disabled selected>No cover letters yet</option>';
        }
        selectPairs.innerHTML = '<option disabled selected>History unavailable</option>';
      }

      window.HIREX?.debugLog?.("COVER LETTER PAGE LOADED",{version:"v2.1.2"});
    });

    // Revoke last PDF URL on unload
    window.addEventListener("beforeunload", () => {
      if (lastPdfUrl) { try { URL.revokeObjectURL(lastPdfUrl); } catch{} }
    });
  </script>
</body>
</html>

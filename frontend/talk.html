<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0a1020" />

  <title>Talk to HIREX | ASTRA ‚Äî AI Career Assistant v2.1.3</title>
  <meta name="description" content="Ask job or interview questions ‚Äî HIREX responds using your saved resume and job description pair." />
  <meta name="author" content="Sri Akash Kadali" />

  <!-- CSP aligned with suite: dev websockets, blobs, workers, about: iframes -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self' blob: data:;
          img-src 'self' data: blob:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval';
          connect-src 'self' blob: http://127.0.0.1:8000 ws://127.0.0.1:8000 http://0.0.0.0:8000 ws://0.0.0.0:8000 http://localhost:8000 ws://localhost:8000 https://api.openai.com;
          frame-src 'self' blob: data: about:;
          child-src 'self' blob:;
          worker-src 'self' blob:;
          font-src 'self' data:;
          media-src 'self' blob: data:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'self';
        " />

  <link rel="icon" type="image/png" href="/static/assets/favicon.png" />
  <link rel="preload" href="/static/assets/logo.png" as="image" />
  <link rel="stylesheet" href="/static/css/base.css?v=2.1.3" />
  <link rel="stylesheet" href="/static/css/animations.css?v=2.1.3" />
  <link rel="stylesheet" href="/static/css/app.css?v=2.1.3" />

  <style>
    :root {
      --bg: #0a0f1a;
      --panel: #101622;
      --accent: #5bd0ff;
      --accent2: #9f78ff;
      --muted: rgba(255,255,255,0.7);
      --radius: 12px;
      --font: "Inter","Outfit",system-ui,sans-serif;
      --sidebar-width: 260px;
      --history-width: 240px;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #e6ecf7;
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      position: relative;
      z-index: 0;
      line-height: 1.6;
    }
    ::selection { background: var(--accent); color: #000; }
    .menu-toggle, .theme-toggle { display: none !important; }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(to right, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px),
        repeating-linear-gradient(to bottom, rgba(255,255,255,0.03) 0 1px, transparent 1px 80px);
      animation: gridFloat 24s linear infinite;
      pointer-events: none;
      z-index: -1;
    }
    body::after {
      content: "";
      position: fixed;
      width: 500px;
      height: 500px;
      top: 30%;
      right: 10%;
      background: radial-gradient(circle, rgba(91,208,255,0.12), transparent 70%);
      filter: blur(100px);
      animation: glowPulse 10s ease-in-out infinite alternate;
      pointer-events: none;
      z-index: -1;
    }
    @keyframes gridFloat { from { background-position: 0 0, 0 0; } to { background-position: 80px 80px, 80px 80px; } }
    @keyframes glowPulse { from { opacity: .8; transform: scale(1); } to { opacity: .6; transform: scale(1.1); } }

    /* Sidebar */
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      width: var(--sidebar-width);
      background: rgba(10,16,32,0.9);
      border-right: 1px solid rgba(255,255,255,0.05);
      z-index: 10; backdrop-filter: blur(10px);
      display: flex; flex-direction: column; padding-top: .25rem;
    }
    .brand { display: flex; align-items: center; gap: .75rem; padding: .6rem 1rem .05rem; }
    .brand img {
      width: 72px; height: auto; aspect-ratio: 1 / 1; object-fit: contain;
      filter: drop-shadow(0 0 6px rgba(91,208,255,0.6));
      transition: transform .25s ease, filter .25s ease;
    }
    .brand img:hover { transform: scale(1.05); filter: drop-shadow(0 0 12px rgba(91,208,255,0.9)); }
    .logo-text {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; background-clip: text;
      color: transparent; font-weight: 700; font-size: 1.35rem; letter-spacing: .4px;
    }

    .vnav { list-style: none; padding: 0; margin: .05rem 1rem 1rem; }
    .vnav li { margin-bottom: .42rem; }
    .vnav a {
      display: block; padding: 0.6rem 1rem; color: #cfd9ff; border-radius: 10px; text-decoration: none;
      transition: background .2s ease, color .2s ease;
    }
    .vnav a:hover, .vnav a.active-link { background: rgba(91,208,255,0.12); color: var(--accent); }

    /* History panel */
    #history-panel {
      position: fixed; left: var(--sidebar-width); top: 0; bottom: 0;
      width: var(--history-width);
      background: rgba(10,16,32,0.9);
      border-right: 1px solid rgba(255,255,255,0.05);
      padding: 1rem; overflow-y: auto; z-index: 9; backdrop-filter: blur(10px);
    }
    #history-panel h3 {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      font-size: 1rem; text-align: center; margin-bottom: 0.75rem; font-weight: 700; letter-spacing: .3px;
    }
    #history-list { list-style: none; margin: 0; padding: 0; }
    #history-list li {
      padding: .6rem .5rem; border-radius: 8px; color: #ccc; cursor: pointer;
      transition: background .2s ease, color .2s ease;
    }
    #history-list li:hover, #history-list li.active { background: rgba(91,208,255,0.18); color: #fff; }

    /* Main */
    main.console {
      margin-left: calc(var(--sidebar-width) + var(--history-width));
      padding: 2.5rem 3rem 4rem;
      max-width: 1000px; position: relative; z-index: 1;
      display: flex; flex-direction: column; gap: 1.8rem; animation: fadeRise 1s ease;
    }
    @keyframes fadeRise { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

    h1.page-title {
      text-align: center; font-size: 2rem; font-weight: 600;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text; background-clip: text; color: transparent;
      margin-bottom: 0.5rem;
    }
    .muted { text-align: center; color: var(--muted); margin-bottom: 2rem; }

    /* Card */
    .card {
      background: var(--panel); border: 1px solid rgba(255,255,255,0.07);
      border-radius: var(--radius); padding: 1.5rem;
      transition: transform .25s ease, box-shadow .25s ease;
      position: relative; z-index: 2; box-shadow: 0 0 20px rgba(91,208,255,0.08);
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(91,208,255,0.22); }

    label {
      font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px;
      text-align: center; text-transform: uppercase; letter-spacing: 0.4px;
    }
    select, textarea {
      width: 100%; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12);
      background: #0e1424; color: #eaf0ff; padding: 10px 12px; font-size: 14px; outline: none;
      transition: border-color .25s, background .25s;
    }
    select:focus, textarea:focus { border-color: var(--accent); background: #111a30; }
    select option { background: #0f1628; color: #eaf0ff; }

    .btn {
      border: none; background: var(--accent); color: #0a0f1a; padding: 10px 14px;
      border-radius: 8px; font-weight: 600; cursor: pointer; transition: background .25s, transform .15s;
    }
    .btn:hover { background: #72d7ff; transform: translateY(-1px); }

    /* Chat */
    .chat-box {
      background: #0f1524; border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px; padding: 14px; overflow-y: auto; height: 65vh;
    }
    .msg { margin-bottom: 12px; max-width: 85%; font-size: 14px; line-height: 1.5;
      padding: 10px 14px; border-radius: 8px; white-space: pre-wrap; word-break: break-word; }
    .msg.user { background: #18243c; color: #eaf0ff; margin-left: auto; }
    .msg.bot  { background: #141b2e; color: #dce4f8; }

    .chat-controls { display: flex; gap: 10px; align-items: flex-start; margin-top: 12px; }
    .chat-controls textarea { flex: 1; min-height: 60px; border-radius: 8px; }

    footer {
      text-align: center; color: #9aa7cc; font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.06);
      padding: 1.5rem; margin-top: 3rem; position: relative; z-index: 2;
    }

    /* Responsive */
    @media(max-width:1100px){
      #history-panel { display: none; }
      main.console { margin-left: var(--sidebar-width); }
    }
    @media(max-width:880px){
      .brand { padding: .5rem 1rem .04rem; }
      .brand img { width: 60px; }
      .logo-text { font-size: 1.2rem; }
      .vnav { margin: .02rem 1rem 1rem; }
    }
    @media(max-width:700px){
      main.console { padding: 1.5rem; }
      .chat-box { height: 60vh; }
    }
  </style>
</head>

<body class="page-enter" data-app="astra">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Primary">
    <div class="brand">
      <img src="/static/assets/logo.png" alt="ASTRA Logo" loading="lazy" />
      <span class="logo-text">ASTRA</span>
    </div>
    <ul class="vnav">
      <li><a href="/index.html">üè† HIREX</a></li>
      <li><a href="/preview.html">üìÑ HIREX Preview</a></li>
      <li><a href="/coverletter.html">‚úâÔ∏è HIREX Letter</a></li>
      <li><a href="/talk.html" aria-current="page" class="active-link">üí¨ Talk to HIREX</a></li>
      <li><a href="/mastermind.html">üß† MasterMind</a></li>
      <li><a href="/superhuman.html">‚ú® SuperHuman</a></li>
      <li><a href="/dashboard.html">üìä Dashboard</a></li>
      <li><a href="/genie.html">üßû Genie</a></li>
    </ul>
  </aside>

  <!-- JD/Resume History Sidebar -->
  <aside id="history-panel" aria-label="Saved JD and Resume History">
    <h3>üìú JD + Resume History</h3>
    <ul id="history-list"></ul>
  </aside>

  <!-- Main -->
  <main id="content" class="console" role="main">
    <h1 class="page-title anim rise">Talk to HIREX</h1>
    <p class="muted">
      Ask job or interview questions ‚Äî HIREX responds using your saved
      <strong>resume</strong> and <strong>job description</strong> pair.
    </p>

    <!-- Context selection -->
    <section class="card anim fade" aria-labelledby="context-label">
      <label id="context-label" for="contextSelect">Select JD + Resume</label>
      <select id="contextSelect" aria-label="JD and Resume selection"></select>
      <div style="text-align:center;margin-top:1rem;">
        <button class="btn" id="loadContext" type="button">Load Context</button>
        <div id="contextStatus" style="font-size:13px;margin-top:8px;color:var(--muted);" aria-live="polite">Idle</div>
      </div>
    </section>

    <!-- Chat -->
    <section class="card anim fade" aria-label="Chat with HIREX">
      <div id="talk-chat" class="chat-box" aria-live="polite">
        <div class="msg bot">üëã Hi! I‚Äôm HIREX ‚Äî ask anything about your role, JD, or fit.</div>
      </div>
      <div class="chat-controls" id="talk-form" role="form" aria-label="Ask HIREX">
        <textarea id="talk-input" placeholder="e.g., 'What makes me a strong fit for this position?'" aria-label="Your question"></textarea>
        <button class="btn" id="talk-send" type="button" aria-label="Send question">Ask</button>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 <strong>ASTRA</strong> ‚Äî Developed by <strong>Sri Akash Kadali</strong> |
    Powered by <strong>FastAPI</strong> + <strong>OpenAI</strong>
  </footer>

  <div id="toast" role="status" aria-live="polite" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0f1524;border:1px solid rgba(255,255,255,0.08);padding:10px 14px;border-radius:8px;z-index:50;"></div>

  <script src="/static/js/util.js?v=2.1.3" defer></script>
  <script src="/static/js/ui.js?v=2.1.3" defer></script>
  <script src="/static/js/talk.js?v=2.1.3" defer></script>

  <script>
    // ===== Utilities =====
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const esc = (v) => String(v ?? "‚Äî").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = (msg, ms=2400) => { const t=$("#toast"); if(!t) return; t.textContent=msg; t.style.display="block"; clearTimeout(window.__t0); window.__t0=setTimeout(()=>t.style.display="none", ms); };
    const setStatus = (s)=>{ const el=$("#contextStatus"); if(el) el.textContent=s; };

    // Stable key for selection dedupe
    const keyFrom = (obj) => {
      if (obj?.key) return String(obj.key).toLowerCase();
      const c = (obj?.company || obj?.company_name || "").toLowerCase().trim().replace(/\s+/g,"_");
      const r = (obj?.role || "").toLowerCase().trim().replace(/\s+/g,"_");
      return `${c}__${r}`;
    };
    const dedupeByKey = (items) => {
      const seen = new Set(); const out = [];
      for (const it of items) {
        const k = keyFrom(it);
        if (!k || seen.has(k)) continue;
        seen.add(k);
        out.push({
          ...it,
          company: it.company || it.company_name || "‚Äî",
          role: it.role || it.title || "‚Äî",
          __key: k
        });
      }
      return out;
    };

    // ===== Backend API (v2.x) =====
    async function listContexts(limit=200) {
      const r = await fetch(`/api/context/list?limit=${limit}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Failed to list contexts");
      const j = await r.json();
      return Array.isArray(j.items) ? j.items : [];
    }
    async function getContextByKey(key) {
      const r = await fetch(`/api/context/get?key=${encodeURIComponent(key)}`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("Context not found");
      return await r.json();
    }
    async function getLatestContext() {
      const r = await fetch(`/api/context/get?latest=1`, { credentials: "same-origin" });
      if (!r.ok) throw new Error("No latest context");
      return await r.json();
    }

    // ===== Persist selection for talk.js & other pages =====
    function persistSelectedContext(ctx) {
      const selected = {
        key: keyFrom(ctx),
        company: ctx.company || ctx.company_name || "",
        role: ctx.role || ctx.title || "",
        jd_text: (ctx.jd_text || ctx.jd || ""),
        resume_tex: (ctx.humanized?.tex || ctx.humanized_tex || ctx.optimized?.tex || ctx.resume_tex || ""),
        pdf_base64: ctx.pdf_base64 || "",
        pdf_base64_humanized: ctx.pdf_base64_humanized || ""
      };
      try {
        localStorage.setItem("hirex_selected_context", JSON.stringify(selected));
        localStorage.setItem("hirex_company", selected.company);
        localStorage.setItem("hirex_role", selected.role);
      } catch {}
      return selected;
    }

    function renderHistoryList(container, items) {
      container.innerHTML = items.map(it =>
        `<li data-key="${esc(it.__key)}" tabindex="0" role="button" aria-label="Select ${esc(it.company)} ‚Äî ${esc(it.role)}">${esc(it.company)} ‚Äî ${esc(it.role)}</li>`
      ).join("");
    }
    function populateSelect(select, items) {
      if (!items.length) {
        select.innerHTML = `<option disabled selected>No saved JD + Resume</option>`;
        return;
      }
      select.innerHTML = items.map(it =>
        `<option value="${esc(it.__key)}">${esc(it.company)} ‚Äî ${esc(it.role)}</option>`
      ).join("");
    }

    // ===== Boot =====
    document.addEventListener("DOMContentLoaded", async () => {
      const select  = $("#contextSelect");
      const list    = $("#history-list");
      const loadBtn = $("#loadContext");

      try {
        setStatus("Loading history‚Ä¶");
        const items = await listContexts(300);
        const uniq  = dedupeByKey(items);

        populateSelect(select, uniq);
        renderHistoryList(list, uniq);

        // Preselect previously chosen context (if exists)
        const prev = (() => { try { return JSON.parse(localStorage.getItem("hirex_selected_context")||"null"); } catch { return null; }})();
        if (prev?.key) {
          select.value = prev.key;
          [...list.children].forEach(li => li.classList.toggle("active", li.dataset.key === prev.key));
        } else if (uniq.length) {
          select.value = uniq[0].__key;
          [...list.children].forEach((li, i) => li.classList.toggle("active", i === 0));
          // Auto-persist newest once so chat works out of the box
          try {
            const ctx = await getContextByKey(uniq[0].__key);
            persistSelectedContext(ctx);
          } catch {}
        } else {
          // Backend empty ‚Äî fallback to local history (best-effort)
          const localHist = (() => { try { return JSON.parse(localStorage.getItem("hirex_history")||"[]"); } catch { return []; }})();
          const dedupLocal = dedupeByKey(localHist);
          populateSelect(select, dedupLocal);
          renderHistoryList(list, dedupLocal);
        }

        // Click on sidebar history selects the item
        list.addEventListener("click", (e) => {
          const li = e.target.closest("li"); if (!li) return;
          const key = li.dataset.key;
          select.value = key;
          [...list.children].forEach(x => x.classList.remove("active"));
          li.classList.add("active");
        });
        // Keyboard select
        list.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            const li = e.target.closest("li"); if (!li) return;
            li.click();
          }
        });

        // Load button: fetch by key and persist
        loadBtn.addEventListener("click", async () => {
          const key = select.value;
          if (!key) return toast("Please select a JD + Resume pair.");
          setStatus("Loading context‚Ä¶");
          try {
            const ctx = await getContextByKey(key);
            const saved = persistSelectedContext(ctx);
            setStatus(`‚úÖ Loaded: ${saved.company || "‚Äî"} ‚Äî ${saved.role || "‚Äî"}`);
            toast("Context loaded.");
          } catch (e) {
            setStatus("‚ö†Ô∏è Failed to load context");
            toast(String(e));
          }
        });

        setStatus("Idle");
      } catch (e) {
        // If backend listing fails, try to at least get the latest context directly
        try {
          const ctx = await getLatestContext();
          const saved = persistSelectedContext(ctx);
          populateSelect($("#contextSelect"), [{company:saved.company, role:saved.role, __key:saved.key}]);
          renderHistoryList($("#history-list"), [{company:saved.company, role:saved.role, __key:saved.key}]);
          setStatus(`‚òÅÔ∏è Loaded latest: ${saved.company} ‚Äî ${saved.role}`);
        } catch {
          setStatus("History unavailable");
          $("#contextSelect").innerHTML = `<option disabled selected>History unavailable</option>`;
          $("#history-list").innerHTML  = `<li>No history yet</li>`;
        }
      }

      (window.ASTRA ?? window.HIREX)?.debugLog?.("TALK PAGE LOADED", { version: "v2.1.3" });
    });
  </script>
</body>
</html>
